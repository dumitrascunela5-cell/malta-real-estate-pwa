<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malta Real Estate PRO</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f97316">
    <link rel="icon" type="image/png" href="./icon-192.png">
    <meta name="description" content="Professional real estate management platform for Malta">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Leaflet for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            /* Professional color scheme - Orange/Teal */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent-primary: #f97316;
            --accent-secondary: #14b8a6;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
        }
        
        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            line-height: 1.2;
        }
        
        #root {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .theme-toggle {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            padding: 0.625rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s;
        }
        
        .theme-toggle:hover {
            transform: rotate(180deg);
        }
        
        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            flex: 1;
        }
        
        /* Welcome Message */
        .welcome-banner {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            color: white;
            box-shadow: 0 4px 20px var(--shadow);
        }
        
        .welcome-banner h2 {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }
        
        .welcome-banner p {
            opacity: 0.95;
            font-size: 1rem;
        }
        
        /* Daily Notes */
        .daily-notes {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }
        
        .daily-notes h3 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .note-item {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 3px solid var(--accent-primary);
        }
        
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }
        
        .note-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .note-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .add-note-form {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .add-note-form input {
            flex: 1;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid var(--border);
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        .tab {
            padding: 0.875rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-weight: 500;
            position: relative;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .tab:hover {
            color: var(--text-primary);
        }
        
        .tab.active {
            color: var(--accent-primary);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-primary);
        }
        
        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        
        .card {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .card-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-available {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .badge-sold {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .badge-active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }
        
        .badge-closed {
            background: rgba(100, 116, 139, 0.1);
            color: var(--text-muted);
        }
        
        .card-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .detail-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin: 0.5rem 0;
        }
        
        .card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0.25rem;
            line-height: 1;
        }
        
        .close-btn:hover {
            color: var(--text-primary);
        }
        
        /* Form */
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        
        select.form-input {
            cursor: pointer;
        }
        
        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Map */
        #map {
            height: 600px;
            border-radius: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .leaflet-popup-content-wrapper {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 0.5rem;
        }
        
        /* Match Score */
        .match-score {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .score-high {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }
        
        .score-medium {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        
        .score-low {
            background: rgba(100, 116, 139, 0.15);
            color: var(--text-muted);
        }
        
        .match-reasons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .reason-tag {
            padding: 0.25rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* Deal Card */
        .deal-card {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }
        
        .deal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .deal-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-closed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .commission-amount {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-secondary);
            margin: 0.5rem 0;
        }
        
        .deal-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Install Banner */
        .install-banner {
            background: linear-gradient(135deg, var(--accent-secondary), var(--info));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .install-banner-content {
            flex: 1;
        }
        
        .install-banner h3 {
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }
        
        .install-banner p {
            opacity: 0.9;
            font-size: 0.875rem;
        }
        
        .install-banner .btn {
            background: white;
            color: var(--info);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        
        .empty-state p {
            margin-bottom: 1.5rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            #map {
                height: 400px;
            }
            
            .deal-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // ===========================
        // SUPABASE CONFIGURATION
        // ===========================
        
        const SUPABASE_URL = 'https://pwblvakxrhbmtjmdwrgv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Ymx2YWt4cmhibXRqbWR3cmd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg2NzEwMzMsImV4cCI6MjA1NDI0NzAzM30.lNsaC_qb1wQQDRWN_Mc63H6d3t1dFRXkUXqpZt3MQnQ';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Malta zones with coordinates and nearby areas
        const MALTA_ZONES = {
            'Sliema': { lat: 35.9120, lng: 14.5015, nearby: ['St. Julians', 'Gzira', 'Msida', 'Ta\' Xbiex'] },
            'St. Julians': { lat: 35.9191, lng: 14.4897, nearby: ['Sliema', 'Paceville', 'Swieqi'] },
            'Valletta': { lat: 35.8989, lng: 14.5146, nearby: ['Floriana', 'Hamrun', 'Msida'] },
            'Gzira': { lat: 35.9064, lng: 14.4947, nearby: ['Sliema', 'Msida', 'Ta\' Xbiex'] },
            'Mellieha': { lat: 35.9555, lng: 14.3625, nearby: ['Mgarr', 'St. Paul\'s Bay'] },
            'Mosta': { lat: 35.9092, lng: 14.4256, nearby: ['Naxxar', 'Lija', 'Attard'] },
            'Birkirkara': { lat: 35.8972, lng: 14.4611, nearby: ['Msida', 'Hamrun', 'Balzan'] },
            'St. Paul\'s Bay': { lat: 35.9500, lng: 14.4000, nearby: ['Mellieha', 'Bugibba', 'Qawra'] },
            'Gozo': { lat: 36.0444, lng: 14.2417, nearby: [] } // Gozo separate
        };
        
        // ===========================
        // MAIN APP COMPONENT
        // ===========================
        
        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [properties, setProperties] = useState([]);
            const [clients, setClients] = useState([]);
            const [deals, setDeals] = useState([]);
            const [dailyNotes, setDailyNotes] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showPropertyModal, setShowPropertyModal] = useState(false);
            const [showClientModal, setShowClientModal] = useState(false);
            const [showDealModal, setShowDealModal] = useState(false);
            const [lightMode, setLightMode] = useState(false);
            const [showInstallBanner, setShowInstallBanner] = useState(false);
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            
            // Load data on mount
            useEffect(() => {
                loadData();
                checkInstallability();
            }, []);
            
            useEffect(() => {
                if (lightMode) {
                    document.body.classList.add('light-mode');
                } else {
                    document.body.classList.remove('light-mode');
                }
            }, [lightMode]);
            
            const checkInstallability = () => {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                    setShowInstallBanner(true);
                });
            };
            
            const handleInstall = async () => {
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    setShowInstallBanner(false);
                }
                
                setDeferredPrompt(null);
            };
            
            const loadData = async () => {
                try {
                    setLoading(true);
                    
                    // Load properties
                    const { data: propsData, error: propsError } = await supabase
                        .from('properties')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (propsError) throw propsError;
                    setProperties(propsData || []);
                    
                    // Load clients
                    const { data: clientsData, error: clientsError } = await supabase
                        .from('clients')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (clientsError) throw clientsError;
                    setClients(clientsData || []);
                    
                    // Load deals (from a deals table or create one)
                    const { data: dealsData, error: dealsError } = await supabase
                        .from('deals')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (!dealsError && dealsData) {
                        setDeals(dealsData);
                    }
                    
                    // Load daily notes (from notes table)
                    const { data: notesData, error: notesError } = await supabase
                        .from('daily_notes')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(10);
                    
                    if (!notesError && notesData) {
                        setDailyNotes(notesData);
                    }
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    alert('Error loading data. Check console for details.');
                } finally {
                    setLoading(false);
                }
            };
            
            const addProperty = async (propertyData) => {
                try {
                    const { data, error } = await supabase
                        .from('properties')
                        .insert([propertyData])
                        .select();
                    
                    if (error) throw error;
                    
                    setProperties([data[0], ...properties]);
                    setShowPropertyModal(false);
                    alert('Property added successfully!');
                } catch (error) {
                    console.error('Error adding property:', error);
                    alert('Error adding property: ' + error.message);
                }
            };
            
            const addClient = async (clientData) => {
                try {
                    const { data, error } = await supabase
                        .from('clients')
                        .insert([clientData])
                        .select();
                    
                    if (error) throw error;
                    
                    setClients([data[0], ...clients]);
                    setShowClientModal(false);
                    alert('Client added successfully!');
                } catch (error) {
                    console.error('Error adding client:', error);
                    alert('Error adding client: ' + error.message);
                }
            };
            
            const addDeal = async (dealData) => {
                try {
                    const { data, error } = await supabase
                        .from('deals')
                        .insert([dealData])
                        .select();
                    
                    if (error) throw error;
                    
                    setDeals([data[0], ...deals]);
                    setShowDealModal(false);
                    alert('Deal added successfully!');
                } catch (error) {
                    console.error('Error adding deal:', error);
                    alert('Error adding deal: ' + error.message);
                }
            };
            
            const addDailyNote = async (noteText) => {
                if (!noteText.trim()) return;
                
                try {
                    const noteData = {
                        content: noteText,
                        created_at: new Date().toISOString()
                    };
                    
                    const { data, error } = await supabase
                        .from('daily_notes')
                        .insert([noteData])
                        .select();
                    
                    if (error) throw error;
                    
                    setDailyNotes([data[0], ...dailyNotes]);
                } catch (error) {
                    console.error('Error adding note:', error);
                    alert('Error adding note: ' + error.message);
                }
            };
            
            // Calculate match score
            const calculateMatch = (property, client) => {
                let score = 0;
                const reasons = [];
                
                // Price matching (40 points) - with 15% tolerance
                const priceDiff = Math.abs(property.price - client.budget);
                const pricePercent = (priceDiff / client.budget) * 100;
                
                if (pricePercent <= 5) {
                    score += 40;
                    reasons.push('üí∞ Price perfect match');
                } else if (pricePercent <= 10) {
                    score += 30;
                    reasons.push('üí∞ Price negotiable');
                } else if (pricePercent <= 15) {
                    score += 20;
                    reasons.push('üí∞ Price within range');
                }
                
                // Location matching (30 points)
                if (property.location.toLowerCase() === client.preferred_location.toLowerCase()) {
                    score += 30;
                    reasons.push('üìç Exact location match');
                } else {
                    const propZone = MALTA_ZONES[property.location];
                    const clientZone = client.preferred_location;
                    
                    if (propZone && propZone.nearby.includes(clientZone)) {
                        score += 20;
                        reasons.push('üìç Nearby location');
                    }
                }
                
                // Property type (20 points)
                if (property.type === client.looking_for) {
                    score += 20;
                    reasons.push('üè† Property type match');
                }
                
                // Bedrooms (10 points)
                if (property.bedrooms >= client.min_bedrooms) {
                    score += 10;
                    reasons.push('üõèÔ∏è Bedrooms requirement met');
                }
                
                return { score, reasons };
            };
            
            const getMatches = () => {
                const matches = [];
                
                clients.forEach(client => {
                    properties.forEach(property => {
                        if (property.status === 'available') {
                            const match = calculateMatch(property, client);
                            
                            if (match.score >= 50) { // 50% threshold
                                matches.push({
                                    client,
                                    property,
                                    score: match.score,
                                    reasons: match.reasons
                                });
                            }
                        }
                    });
                });
                
                return matches.sort((a, b) => b.score - a.score);
            };
            
            // Calculate total commission
            const totalCommission = deals
                .filter(d => d.status === 'closed')
                .reduce((sum, d) => sum + (d.commission || 0), 0);
            
            const pendingCommission = deals
                .filter(d => d.status === 'pending')
                .reduce((sum, d) => sum + (d.commission || 0), 0);
            
            return (
                <>
                    <header className="header">
                        <div className="header-content">
                            <div className="header-left">
                                <div className="logo">üè† Malta RE PRO</div>
                            </div>
                            <div className="header-actions">
                                <button className="btn btn-primary" onClick={() => setShowPropertyModal(true)}>
                                    + Add Property
                                </button>
                                <button className="btn btn-primary" onClick={() => setShowClientModal(true)}>
                                    + Add Client
                                </button>
                                {activeTab === 'deals' && (
                                    <button className="btn btn-primary" onClick={() => setShowDealModal(true)}>
                                        + Add Deal
                                    </button>
                                )}
                                <button className="theme-toggle" onClick={() => setLightMode(!lightMode)}>
                                    {lightMode ? 'üåô' : '‚òÄÔ∏è'}
                                </button>
                            </div>
                        </div>
                    </header>
                    
                    <div className="container">
                        {showInstallBanner && (
                            <div className="install-banner">
                                <div className="install-banner-content">
                                    <h3>üì± Install Malta RE PRO</h3>
                                    <p>Get the app on your device for the best experience!</p>
                                </div>
                                <div style={{display: 'flex', gap: '0.5rem'}}>
                                    <button className="btn" onClick={handleInstall}>Install</button>
                                    <button className="btn btn-secondary" onClick={() => setShowInstallBanner(false)}>‚úï</button>
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'dashboard' && (
                            <>
                                <div className="welcome-banner">
                                    <h2>üëã Welcome Back!</h2>
                                    <p>Manage your Malta real estate portfolio like a pro</p>
                                </div>
                                
                                <DailyNotes notes={dailyNotes} onAddNote={addDailyNote} />
                                
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginBottom: '2rem'}}>
                                    <div style={{background: 'var(--bg-secondary)', padding: '1.5rem', borderRadius: '1rem', border: '1px solid var(--border)'}}>
                                        <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem'}}>Total Properties</div>
                                        <div style={{fontSize: '2rem', fontWeight: 'bold', color: 'var(--accent-primary)'}}>{properties.length}</div>
                                    </div>
                                    <div style={{background: 'var(--bg-secondary)', padding: '1.5rem', borderRadius: '1rem', border: '1px solid var(--border)'}}>
                                        <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem'}}>Total Clients</div>
                                        <div style={{fontSize: '2rem', fontWeight: 'bold', color: 'var(--accent-secondary)'}}>{clients.length}</div>
                                    </div>
                                    <div style={{background: 'var(--bg-secondary)', padding: '1.5rem', borderRadius: '1rem', border: '1px solid var(--border)'}}>
                                        <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem'}}>Smart Matches</div>
                                        <div style={{fontSize: '2rem', fontWeight: 'bold', color: 'var(--success)'}}>{getMatches().length}</div>
                                    </div>
                                    <div style={{background: 'var(--bg-secondary)', padding: '1.5rem', borderRadius: '1rem', border: '1px solid var(--border)'}}>
                                        <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem'}}>Total Commission</div>
                                        <div style={{fontSize: '2rem', fontWeight: 'bold', color: 'var(--warning)'}}>‚Ç¨{totalCommission.toLocaleString()}</div>
                                    </div>
                                </div>
                            </>
                        )}
                        
                        <div className="tabs">
                            <button className={`tab ${activeTab === 'dashboard' ? 'active' : ''}`} onClick={() => setActiveTab('dashboard')}>
                                Dashboard
                            </button>
                            <button className={`tab ${activeTab === 'properties' ? 'active' : ''}`} onClick={() => setActiveTab('properties')}>
                                Properties ({properties.length})
                            </button>
                            <button className={`tab ${activeTab === 'clients' ? 'active' : ''}`} onClick={() => setActiveTab('clients')}>
                                Clients ({clients.length})
                            </button>
                            <button className={`tab ${activeTab === 'matches' ? 'active' : ''}`} onClick={() => setActiveTab('matches')}>
                                Smart Matches ({getMatches().length})
                            </button>
                            <button className={`tab ${activeTab === 'deals' ? 'active' : ''}`} onClick={() => setActiveTab('deals')}>
                                Deals ({deals.length})
                            </button>
                            <button className={`tab ${activeTab === 'map' ? 'active' : ''}`} onClick={() => setActiveTab('map')}>
                                Map
                            </button>
                        </div>
                        
                        {loading ? (
                            <div style={{textAlign: 'center', padding: '4rem', color: 'var(--text-muted)'}}>
                                Loading...
                            </div>
                        ) : (
                            <>
                                {activeTab === 'properties' && (
                                    <PropertiesTab properties={properties} />
                                )}
                                
                                {activeTab === 'clients' && (
                                    <ClientsTab clients={clients} />
                                )}
                                
                                {activeTab === 'matches' && (
                                    <MatchesTab matches={getMatches()} />
                                )}
                                
                                {activeTab === 'deals' && (
                                    <DealsTab deals={deals} totalCommission={totalCommission} pendingCommission={pendingCommission} />
                                )}
                                
                                {activeTab === 'map' && (
                                    <MapTab properties={properties} />
                                )}
                            </>
                        )}
                    </div>
                    
                    {showPropertyModal && (
                        <PropertyModal onClose={() => setShowPropertyModal(false)} onAdd={addProperty} />
                    )}
                    
                    {showClientModal && (
                        <ClientModal onClose={() => setShowClientModal(false)} onAdd={addClient} />
                    )}
                    
                    {showDealModal && (
                        <DealModal 
                            onClose={() => setShowDealModal(false)} 
                            onAdd={addDeal}
                            properties={properties}
                            clients={clients}
                        />
                    )}
                </>
            );
        }
        
        // ===========================
        // DAILY NOTES COMPONENT
        // ===========================
        
        function DailyNotes({ notes, onAddNote }) {
            const [newNote, setNewNote] = useState('');
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onAddNote(newNote);
                setNewNote('');
            };
            
            return (
                <div className="daily-notes">
                    <h3>üìù Daily Notes & Updates</h3>
                    
                    <form className="add-note-form" onSubmit={handleSubmit}>
                        <input
                            type="text"
                            className="form-input"
                            placeholder="Add a note about today's client conversations..."
                            value={newNote}
                            onChange={(e) => setNewNote(e.target.value)}
                        />
                        <button type="submit" className="btn btn-primary">Add Note</button>
                    </form>
                    
                    <div className="notes-list">
                        {notes.length === 0 ? (
                            <div style={{textAlign: 'center', padding: '2rem', color: 'var(--text-muted)'}}>
                                No notes yet. Add your first note above!
                            </div>
                        ) : (
                            notes.map((note, index) => (
                                <div key={note.id || index} className="note-item">
                                    <div className="note-header">
                                        <div className="note-meta">
                                            {new Date(note.created_at).toLocaleString()}
                                        </div>
                                    </div>
                                    <div className="note-content">{note.content}</div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }
        
        // ===========================
        // PROPERTIES TAB
        // ===========================
        
        function PropertiesTab({ properties }) {
            if (properties.length === 0) {
                return (
                    <div className="empty-state">
                        <div className="empty-state-icon">üè†</div>
                        <h3>No Properties Yet</h3>
                        <p>Add your first property to get started</p>
                        <button className="btn btn-primary">Add Property</button>
                    </div>
                );
            }
            
            return (
                <div className="cards-grid">
                    {properties.map(property => (
                        <div key={property.id} className="card">
                            <div className="card-header">
                                <div>
                                    <div className="card-title">{property.title}</div>
                                    <div style={{color: 'var(--text-muted)', fontSize: '0.875rem'}}>{property.type}</div>
                                </div>
                                <span className={`card-badge badge-${property.status}`}>
                                    {property.status}
                                </span>
                            </div>
                            
                            <div className="price">‚Ç¨{property.price.toLocaleString()}</div>
                            
                            <div className="card-details">
                                <div className="detail-row">
                                    <span>üìç</span>
                                    <span>{property.location}</span>
                                </div>
                                <div className="detail-row">
                                    <span>üõèÔ∏è</span>
                                    <span>{property.bedrooms} Bedrooms</span>
                                </div>
                                {property.size_sqm && (
                                    <div className="detail-row">
                                        <span>üìê</span>
                                        <span>{property.size_sqm} m¬≤</span>
                                    </div>
                                )}
                            </div>
                            
                            {property.description && (
                                <div style={{marginTop: '1rem', color: 'var(--text-secondary)', fontSize: '0.875rem'}}>
                                    {property.description}
                                </div>
                            )}
                            
                            <div className="card-actions">
                                <button className="btn btn-primary btn-small">View Details</button>
                                <button className="btn btn-secondary btn-small">Edit</button>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }
        
        // ===========================
        // CLIENTS TAB
        // ===========================
        
        function ClientsTab({ clients }) {
            if (clients.length === 0) {
                return (
                    <div className="empty-state">
                        <div className="empty-state-icon">üë•</div>
                        <h3>No Clients Yet</h3>
                        <p>Add your first client to start matching</p>
                        <button className="btn btn-primary">Add Client</button>
                    </div>
                );
            }
            
            return (
                <div className="cards-grid">
                    {clients.map(client => (
                        <div key={client.id} className="card">
                            <div className="card-header">
                                <div>
                                    <div className="card-title">{client.name}</div>
                                    <div style={{color: 'var(--text-muted)', fontSize: '0.875rem'}}>{client.phone}</div>
                                </div>
                                <span className={`card-badge badge-${client.status}`}>
                                    {client.status}
                                </span>
                            </div>
                            
                            <div className="price">‚Ç¨{client.budget.toLocaleString()}</div>
                            
                            <div className="card-details">
                                <div className="detail-row">
                                    <span>üè†</span>
                                    <span>Looking for: {client.looking_for}</span>
                                </div>
                                <div className="detail-row">
                                    <span>üìç</span>
                                    <span>Preferred: {client.preferred_location}</span>
                                </div>
                                <div className="detail-row">
                                    <span>üõèÔ∏è</span>
                                    <span>Min {client.min_bedrooms} Bedrooms</span>
                                </div>
                            </div>
                            
                            {client.notes && (
                                <div style={{marginTop: '1rem', color: 'var(--text-secondary)', fontSize: '0.875rem'}}>
                                    {client.notes}
                                </div>
                            )}
                            
                            <div className="card-actions">
                                <button className="btn btn-primary btn-small">üìû Call</button>
                                <button className="btn btn-secondary btn-small">View Details</button>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }
        
        // ===========================
        // MATCHES TAB
        // ===========================
        
        function MatchesTab({ matches }) {
            if (matches.length === 0) {
                return (
                    <div className="empty-state">
                        <div className="empty-state-icon">üéØ</div>
                        <h3>No Matches Found</h3>
                        <p>Add properties and clients to see smart matches</p>
                    </div>
                );
            }
            
            return (
                <div className="cards-grid">
                    {matches.map((match, index) => (
                        <div key={index} className="card">
                            <div style={{marginBottom: '1rem'}}>
                                <div className="card-title">{match.client.name}</div>
                                <div style={{color: 'var(--text-muted)', fontSize: '0.875rem', marginTop: '0.25rem'}}>
                                    ‚ÜîÔ∏è {match.property.title}
                                </div>
                            </div>
                            
                            <div className={`match-score score-${match.score >= 70 ? 'high' : match.score >= 50 ? 'medium' : 'low'}`}>
                                {match.score}% Match üî•
                            </div>
                            
                            <div className="match-reasons">
                                {match.reasons.map((reason, i) => (
                                    <div key={i} className="reason-tag">{reason}</div>
                                ))}
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', margin: '1rem 0', paddingTop: '1rem', borderTop: '1px solid var(--border)'}}>
                                <div>
                                    <div style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>Client Budget</div>
                                    <div style={{fontWeight: '600', marginTop: '0.25rem'}}>‚Ç¨{match.client.budget.toLocaleString()}</div>
                                </div>
                                <div>
                                    <div style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>Property Price</div>
                                    <div style={{fontWeight: '600', marginTop: '0.25rem'}}>‚Ç¨{match.property.price.toLocaleString()}</div>
                                </div>
                            </div>
                            
                            <div className="card-actions">
                                <button className="btn btn-primary btn-small">üìû Call Client</button>
                                <button className="btn btn-secondary btn-small">Schedule Viewing</button>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }
        
        // ===========================
        // DEALS TAB
        // ===========================
        
        function DealsTab({ deals, totalCommission, pendingCommission }) {
            if (deals.length === 0) {
                return (
                    <div className="empty-state">
                        <div className="empty-state-icon">üí∞</div>
                        <h3>No Deals Yet</h3>
                        <p>Track your closed deals and commissions here</p>
                    </div>
                );
            }
            
            return (
                <>
                    <div className="deal-stats">
                        <div className="stat-item">
                            <div className="stat-label">Total Closed</div>
                            <div className="stat-value">{deals.filter(d => d.status === 'closed').length}</div>
                        </div>
                        <div className="stat-item">
                            <div className="stat-label">Commission Earned</div>
                            <div className="stat-value">‚Ç¨{totalCommission.toLocaleString()}</div>
                        </div>
                        <div className="stat-item">
                            <div className="stat-label">Pending</div>
                            <div className="stat-value">‚Ç¨{pendingCommission.toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <div style={{marginTop: '2rem'}}>
                        {deals.map(deal => (
                            <div key={deal.id} className="deal-card">
                                <div className="deal-header">
                                    <div>
                                        <div className="card-title">{deal.property_title}</div>
                                        <div style={{color: 'var(--text-muted)', fontSize: '0.875rem', marginTop: '0.25rem'}}>
                                            Client: {deal.client_name}
                                        </div>
                                    </div>
                                    <span className={`deal-status status-${deal.status}`}>
                                        {deal.status}
                                    </span>
                                </div>
                                
                                <div className="commission-amount">
                                    ‚Ç¨{deal.commission.toLocaleString()} Commission
                                </div>
                                
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '1rem', marginTop: '1rem'}}>
                                    <div>
                                        <div style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>Sale Price</div>
                                        <div style={{fontWeight: '600', marginTop: '0.25rem'}}>‚Ç¨{deal.sale_price.toLocaleString()}</div>
                                    </div>
                                    <div>
                                        <div style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>Commission %</div>
                                        <div style={{fontWeight: '600', marginTop: '0.25rem'}}>{deal.commission_percent}%</div>
                                    </div>
                                    <div>
                                        <div style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>Closed Date</div>
                                        <div style={{fontWeight: '600', marginTop: '0.25rem'}}>
                                            {new Date(deal.closed_date).toLocaleDateString()}
                                        </div>
                                    </div>
                                </div>
                                
                                {deal.notes && (
                                    <div style={{marginTop: '1rem', padding: '1rem', background: 'var(--bg-tertiary)', borderRadius: '0.5rem', fontSize: '0.875rem'}}>
                                        {deal.notes}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </>
            );
        }
        
        // ===========================
        // MAP TAB
        // ===========================
        
        function MapTab({ properties }) {
            useEffect(() => {
                const map = L.map('map').setView([35.9375, 14.3754], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                properties.forEach(property => {
                    const zone = MALTA_ZONES[property.location];
                    if (zone) {
                        const marker = L.marker([zone.lat, zone.lng]).addTo(map);
                        marker.bindPopup(`
                            <div style="color: black;">
                                <strong>${property.title}</strong><br>
                                ${property.type} - ${property.bedrooms} beds<br>
                                <strong>‚Ç¨${property.price.toLocaleString()}</strong><br>
                                üìç ${property.location}
                            </div>
                        `);
                    }
                });
                
                return () => {
                    map.remove();
                };
            }, [properties]);
            
            return <div id="map"></div>;
        }
        
        // ===========================
        // PROPERTY MODAL
        // ===========================
        
        function PropertyModal({ onClose, onAdd }) {
            const [formData, setFormData] = useState({
                title: '',
                type: 'Apartment',
                location: 'Sliema',
                price: '',
                bedrooms: '',
                bathrooms: '',
                size_sqm: '',
                description: '',
                status: 'available',
                owner_name: '',
                owner_contact: ''
            });
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd({
                    ...formData,
                    price: parseFloat(formData.price),
                    bedrooms: parseInt(formData.bedrooms),
                    bathrooms: formData.bathrooms ? parseInt(formData.bathrooms) : null,
                    size_sqm: formData.size_sqm ? parseFloat(formData.size_sqm) : null
                });
            };
            
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Add New Property</h2>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Title *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    required
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Type *</label>
                                <select
                                    className="form-input"
                                    required
                                    value={formData.type}
                                    onChange={(e) => setFormData({...formData, type: e.target.value})}
                                >
                                    <option value="Apartment">Apartment</option>
                                    <option value="House">House</option>
                                    <option value="Villa">Villa</option>
                                    <option value="Commercial">Commercial</option>
                                </select>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Location *</label>
                                <select
                                    className="form-input"
                                    required
                                    value={formData.location}
                                    onChange={(e) => setFormData({...formData, location: e.target.value})}
                                >
                                    {Object.keys(MALTA_ZONES).map(zone => (
                                        <option key={zone} value={zone}>{zone}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Price (‚Ç¨) *</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    required
                                    value={formData.price}
                                    onChange={(e) => setFormData({...formData, price: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Bedrooms *</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    required
                                    value={formData.bedrooms}
                                    onChange={(e) => setFormData({...formData, bedrooms: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Bathrooms</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    value={formData.bathrooms}
                                    onChange={(e) => setFormData({...formData, bathrooms: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Size (m¬≤)</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    value={formData.size_sqm}
                                    onChange={(e) => setFormData({...formData, size_sqm: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Owner Name</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.owner_name}
                                    onChange={(e) => setFormData({...formData, owner_name: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Owner Contact</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="Phone number"
                                    value={formData.owner_contact}
                                    onChange={(e) => setFormData({...formData, owner_contact: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Description</label>
                                <textarea
                                    className="form-input"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                />
                            </div>
                            
                            <div style={{display: 'flex', gap: '0.75rem', marginTop: '1.5rem'}}>
                                <button type="submit" className="btn btn-primary" style={{flex: 1}}>
                                    Add Property
                                </button>
                                <button type="button" className="btn btn-secondary" onClick={onClose}>
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        
        // ===========================
        // CLIENT MODAL
        // ===========================
        
        function ClientModal({ onClose, onAdd }) {
            const [formData, setFormData] = useState({
                name: '',
                phone: '',
                looking_for: 'Apartment',
                preferred_location: 'Sliema',
                budget: '',
                min_bedrooms: '',
                max_bedrooms: '',
                notes: '',
                status: 'active'
            });
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd({
                    ...formData,
                    budget: parseFloat(formData.budget),
                    min_bedrooms: parseInt(formData.min_bedrooms),
                    max_bedrooms: formData.max_bedrooms ? parseInt(formData.max_bedrooms) : null
                });
            };
            
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Add New Client</h2>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Name *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    required
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Phone *</label>
                                <input
                                    type="tel"
                                    className="form-input"
                                    required
                                    placeholder="+356 9999 9999"
                                    value={formData.phone}
                                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Looking For *</label>
                                <select
                                    className="form-input"
                                    required
                                    value={formData.looking_for}
                                    onChange={(e) => setFormData({...formData, looking_for: e.target.value})}
                                >
                                    <option value="Apartment">Apartment</option>
                                    <option value="House">House</option>
                                    <option value="Villa">Villa</option>
                                    <option value="Commercial">Commercial</option>
                                </select>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Preferred Location *</label>
                                <select
                                    className="form-input"
                                    required
                                    value={formData.preferred_location}
                                    onChange={(e) => setFormData({...formData, preferred_location: e.target.value})}
                                >
                                    {Object.keys(MALTA_ZONES).map(zone => (
                                        <option key={zone} value={zone}>{zone}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Budget (‚Ç¨) *</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    required
                                    value={formData.budget}
                                    onChange={(e) => setFormData({...formData, budget: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Minimum Bedrooms *</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    required
                                    value={formData.min_bedrooms}
                                    onChange={(e) => setFormData({...formData, min_bedrooms: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Maximum Bedrooms</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    value={formData.max_bedrooms}
                                    onChange={(e) => setFormData({...formData, max_bedrooms: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Notes</label>
                                <textarea
                                    className="form-input"
                                    placeholder="Any special requirements or notes..."
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                />
                            </div>
                            
                            <div style={{display: 'flex', gap: '0.75rem', marginTop: '1.5rem'}}>
                                <button type="submit" className="btn btn-primary" style={{flex: 1}}>
                                    Add Client
                                </button>
                                <button type="button" className="btn btn-secondary" onClick={onClose}>
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        
        // ===========================
        // DEAL MODAL
        // ===========================
        
        function DealModal({ onClose, onAdd, properties, clients }) {
            const [formData, setFormData] = useState({
                property_title: '',
                client_name: '',
                sale_price: '',
                commission_percent: '3',
                commission: '',
                status: 'pending',
                closed_date: new Date().toISOString().split('T')[0],
                notes: ''
            });
            
            useEffect(() => {
                if (formData.sale_price && formData.commission_percent) {
                    const commission = (parseFloat(formData.sale_price) * parseFloat(formData.commission_percent)) / 100;
                    setFormData(prev => ({...prev, commission: commission.toFixed(2)}));
                }
            }, [formData.sale_price, formData.commission_percent]);
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd({
                    ...formData,
                    sale_price: parseFloat(formData.sale_price),
                    commission_percent: parseFloat(formData.commission_percent),
                    commission: parseFloat(formData.commission)
                });
            };
            
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Add New Deal</h2>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Property *</label>
                                <select
                                    className="form-input"
                                    required
                                    value={formData.property_title}
                                    onChange={(e) => setFormData({...formData, property_title: e.target.value})}
                                >
                                    <option value="">Select Property</option>
                                    {properties.map(prop => (
                                        <option key={prop.id} value={prop.title}>{prop.title}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Client *</label>
                                <select
                                    className="form-input"
                                    required
                                    value={formData.client_name}
                                    onChange={(e) => setFormData({...formData, client_name: e.target.value})}
                                >
                                    <option value="">Select Client</option>
                                    {clients.map(client => (
                                        <option key={client.id} value={client.name}>{client.name}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Sale Price (‚Ç¨) *</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    required
                                    value={formData.sale_price}
                                    onChange={(e) => setFormData({...formData, sale_price: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Commission % *</label>
                                <input
                                    type="number"
                                    step="0.5"
                                    className="form-input"
                                    required
                                    value={formData.commission_percent}
                                    onChange={(e) => setFormData({...formData, commission_percent: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Commission Amount (‚Ç¨)</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    value={formData.commission}
                                    readOnly
                                    style={{background: 'var(--bg-tertiary)'}}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Status *</label>
                                <select
                                    className="form-input"
                                    required
                                    value={formData.status}
                                    onChange={(e) => setFormData({...formData, status: e.target.value})}
                                >
                                    <option value="pending">Pending</option>
                                    <option value="closed">Closed</option>
                                </select>
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Closed Date *</label>
                                <input
                                    type="date"
                                    className="form-input"
                                    required
                                    value={formData.closed_date}
                                    onChange={(e) => setFormData({...formData, closed_date: e.target.value})}
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Notes</label>
                                <textarea
                                    className="form-input"
                                    placeholder="Deal notes..."
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                />
                            </div>
                            
                            <div style={{display: 'flex', gap: '0.75rem', marginTop: '1.5rem'}}>
                                <button type="submit" className="btn btn-primary" style={{flex: 1}}>
                                    Add Deal
                                </button>
                                <button type="button" className="btn btn-secondary" onClick={onClose}>
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        
        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
        
        // Service Worker Registration with Update Detection
        if ('serviceWorker' in navigator) {
            let refreshing = false;
            
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('‚úÖ Service Worker registered');
                    
                    // Check for updates every 60 seconds
                    setInterval(() => {
                        registration.update();
                    }, 60000);
                    
                    // Detect when new service worker is waiting
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available!
                                showUpdateBanner();
                            }
                        });
                    });
                })
                .catch(err => console.error('‚ùå Service Worker registration failed:', err));
            
            // Reload when new service worker takes control
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    window.location.reload();
                }
            });
        }

        // Show update banner when new version is available
        function showUpdateBanner() {
            const banner = document.createElement('div');
            banner.id = 'update-banner';
            banner.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, #f97316 0%, #14b8a6 100%);
                    color: white;
                    padding: 15px;
                    text-align: center;
                    z-index: 10000;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    animation: slideDown 0.3s ease;
                ">
                    <div style="max-width: 600px; margin: 0 auto;">
                        <strong>üéâ New version available!</strong>
                        <button onclick="updateApp()" style="
                            margin-left: 15px;
                            background: white;
                            color: #f97316;
                            border: none;
                            padding: 8px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-weight: bold;
                        ">
                            Update Now
                        </button>
                        <button onclick="dismissUpdate()" style="
                            margin-left: 10px;
                            background: transparent;
                            color: white;
                            border: 1px solid white;
                            padding: 8px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                        ">
                            Later
                        </button>
                    </div>
                </div>
            `;
            document.body.prepend(banner);
        }

        function updateApp() {
            navigator.serviceWorker.getRegistration().then(reg => {
                if (reg && reg.waiting) {
                    reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                }
            });
        }

        function dismissUpdate() {
            const banner = document.getElementById('update-banner');
            if (banner) banner.remove();
        }

        // PWA Install Banner
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show banner after 3 seconds
            setTimeout(showInstallBanner, 3000);
        });

        function showInstallBanner() {
            // Don't show if already exists
            if (document.getElementById('install-banner')) return;
            
            const installBanner = document.createElement('div');
            installBanner.id = 'install-banner';
            installBanner.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: white;
                    color: #333;
                    padding: 20px 30px;
                    border-radius: 10px;
                    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                    z-index: 9999;
                    max-width: 400px;
                    animation: slideUp 0.3s ease;
                ">
                    <div style="text-align: center;">
                        <div style="font-size: 40px; margin-bottom: 10px;">üì±</div>
                        <strong style="font-size: 18px; display: block; margin-bottom: 10px;">
                            Install Malta RE PRO
                        </strong>
                        <p style="margin: 10px 0; color: #666;">
                            Add to your home screen for quick access
                        </p>
                        <button onclick="installApp()" style="
                            background: linear-gradient(135deg, #f97316 0%, #14b8a6 100%);
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-weight: bold;
                            font-size: 16px;
                            width: 100%;
                            margin-top: 10px;
                        ">
                            Install Now
                        </button>
                        <button onclick="dismissInstall()" style="
                            background: transparent;
                            color: #666;
                            border: none;
                            padding: 10px;
                            cursor: pointer;
                            margin-top: 5px;
                            width: 100%;
                        ">
                            Maybe Later
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes slideUp {
                        from { transform: translate(-50%, 100px); opacity: 0; }
                        to { transform: translate(-50%, 0); opacity: 1; }
                    }
                    @keyframes slideDown {
                        from { transform: translateY(-100%); }
                        to { transform: translateY(0); }
                    }
                </style>
            `;
            document.body.appendChild(installBanner);
        }

        async function installApp() {
            if (!deferredPrompt) {
                alert('Install feature not available. Try opening in Chrome or Edge.');
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('‚úÖ App installed');
            }
            
            deferredPrompt = null;
            dismissInstall();
        }

        function dismissInstall() {
            const banner = document.getElementById('install-banner');
            if (banner) banner.remove();
        }

        // Check if already installed
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ Malta RE PRO installed!');
            dismissInstall();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malta Real Estate PRO</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f97316">
    <link rel="icon" type="image/png" href="./icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Malta RE">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        html, body, #root {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #0f172a;
            color: #e2e8f0;
        }
        
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        
        .tab-active { 
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.6);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            box-shadow: 0 4px 15px rgba(20, 184, 166, 0.4);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(20, 184, 166, 0.6);
        }
        
        .card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
            border-color: rgba(249, 115, 22, 0.3);
        }
        
        .match-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .loading-spinner {
            border: 3px solid rgba(249, 115, 22, 0.2);
            border-top: 3px solid #f97316;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .sidebar {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-right: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .note-summary {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
        }
        
        ::-webkit-scrollbar-thumb {
            background: #f97316;
            border-radius: 4px;
        }
        
        .input-field {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        
        .match-score {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ===== SUPABASE CONFIGURATION =====
        const SUPABASE_URL = 'https://xevlfdjyvhhnyvxtwzsb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhldmxmZGp5dmhobnl2eHR3enNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDQyODgsImV4cCI6MjA4NTg4MDI4OH0.vf9y_5h7jBKLEWP3AcGx3bvKZObukIXoHYLtdY42pwM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ===== SMART MATCHING ALGORITHM =====
        function calculateMatch(property, client) {
            let score = 0;
            let reasons = [];

            // Price matching (30 points) - ¬±15% tolerance
            const priceLower = client.budget * 0.85;
            const priceUpper = client.budget * 1.15;
            if (property.price >= priceLower && property.price <= priceUpper) {
                score += 30;
                reasons.push(`Price match (‚Ç¨${property.price.toLocaleString()} within budget)`);
            } else if (property.price < priceLower) {
                const diff = ((client.budget - property.price) / client.budget) * 100;
                score += Math.max(0, 30 - diff);
                reasons.push(`Below budget by ${diff.toFixed(0)}%`);
            } else {
                const diff = ((property.price - client.budget) / client.budget) * 100;
                score += Math.max(0, 30 - diff);
                reasons.push(`Above budget by ${diff.toFixed(0)}%`);
            }

            // Property type matching (25 points)
            if (property.type === client.looking_for) {
                score += 25;
                reasons.push(`Perfect type match (${property.type})`);
            }

            // Location matching (25 points)
            const locationMatch = checkLocationProximity(property.location, client.preferred_location);
            score += locationMatch.score;
            if (locationMatch.match) {
                reasons.push(locationMatch.reason);
            }

            // Bedroom matching (20 points)
            if (property.bedrooms >= client.min_bedrooms && 
                property.bedrooms <= (client.max_bedrooms || client.min_bedrooms + 2)) {
                score += 20;
                reasons.push(`Bedroom count fits (${property.bedrooms} beds)`);
            } else {
                const diff = Math.abs(property.bedrooms - client.min_bedrooms);
                score += Math.max(0, 20 - diff * 5);
            }

            return {
                score: Math.min(100, Math.round(score)),
                reasons: reasons
            };
        }

        // Location proximity checker
        function checkLocationProximity(propLocation, clientLocation) {
            const normalizedProp = propLocation.toLowerCase().trim();
            const normalizedClient = clientLocation.toLowerCase().trim();

            // Exact match
            if (normalizedProp === normalizedClient) {
                return { match: true, score: 25, reason: `Exact location match (${propLocation})` };
            }

            // Nearby areas mapping
            const nearbyAreas = {
                'sliema': ['gzira', 'st. julians', 'ta xbiex', 'msida'],
                'gzira': ['sliema', 'msida', 'ta xbiex'],
                'st. julians': ['sliema', 'paceville', 'swieqi'],
                'valletta': ['floriana', 'hamrun', 'marsa'],
                'mellieha': ['st. pauls bay', 'bugibba', 'qawra'],
                'mosta': ['naxxar', 'attard', 'lija'],
                'birkirkara': ['hamrun', 'santa venera', 'msida'],
                'qormi': ['hamrun', 'marsa', 'luqa']
            };

            // Check if locations are nearby
            for (let [area, nearby] of Object.entries(nearbyAreas)) {
                if (normalizedClient.includes(area)) {
                    for (let nearbyArea of nearby) {
                        if (normalizedProp.includes(nearbyArea)) {
                            return { 
                                match: true, 
                                score: 15, 
                                reason: `Nearby location (${propLocation} near ${clientLocation})` 
                            };
                        }
                    }
                }
            }

            return { match: false, score: 0, reason: '' };
        }

        // ===== AI NOTE SUMMARIZER =====
        function summarizeNotes(notes) {
            if (!notes || notes.length === 0) return '';

            // Group notes by type
            const summaries = [];
            const noteText = notes.join('. ');

            // Extract key information
            if (noteText.match(/interested|like|love|want/i)) {
                summaries.push('Client shows strong interest');
            }
            if (noteText.match(/offer|bid|propose/i)) {
                summaries.push('Offer discussed');
            }
            if (noteText.match(/viewing|visit|showing/i)) {
                summaries.push('Viewing scheduled or completed');
            }
            if (noteText.match(/concern|worry|issue/i)) {
                summaries.push('Client has concerns');
            }
            if (noteText.match(/follow.?up|callback|contact/i)) {
                summaries.push('Follow-up required');
            }

            return summaries.length > 0 
                ? summaries.join(' ‚Ä¢ ') 
                : 'General notes recorded';
        }

        // ===== MAIN APP COMPONENT =====
        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [properties, setProperties] = useState([]);
            const [clients, setClients] = useState([]);
            const [propertyNotes, setPropertyNotes] = useState({});
            const [clientNotes, setClientNotes] = useState({});
            const [loading, setLoading] = useState(true);
            const [showInstallBanner, setShowInstallBanner] = useState(false);

            // Form States
            const [propForm, setPropForm] = useState({
                title: '',
                price: '',
                location: '',
                type: 'Apartment',
                bedrooms: 1,
                bathrooms: 1,
                size_sqm: '',
                description: '',
                owner_name: '',
                owner_contact: ''
            });

            const [clientForm, setClientForm] = useState({
                name: '',
                phone: '',
                looking_for: 'Apartment',
                preferred_location: '',
                budget: '',
                min_bedrooms: 1,
                max_bedrooms: 3,
                notes: ''
            });

            const [newNote, setNewNote] = useState('');
            const [selectedEntity, setSelectedEntity] = useState(null);
            const [noteType, setNoteType] = useState('property');

            // ===== CALCULATE MATCHES =====
            const matches = useMemo(() => {
                const allMatches = [];
                
                properties.forEach(property => {
                    clients.forEach(client => {
                        const matchResult = calculateMatch(property, client);
                        if (matchResult.score >= 50) { // Only show matches above 50%
                            allMatches.push({
                                property,
                                client,
                                score: matchResult.score,
                                reasons: matchResult.reasons
                            });
                        }
                    });
                });

                return allMatches.sort((a, b) => b.score - a.score);
            }, [properties, clients]);

            // ===== FETCH DATA =====
            useEffect(() => {
                fetchAllData();
            }, []);

            async function fetchAllData() {
                setLoading(true);
                try {
                    const [propsData, clientsData] = await Promise.all([
                        supabaseClient.from('properties').select('*').order('created_at', { ascending: false }),
                        supabaseClient.from('clients').select('*').order('created_at', { ascending: false })
                    ]);

                    if (propsData.error) throw propsData.error;
                    if (clientsData.error) throw clientsData.error;

                    setProperties(propsData.data || []);
                    setClients(clientsData.data || []);

                    // Initialize notes from database notes field
                    const propNotes = {};
                    const cliNotes = {};
                    
                    (propsData.data || []).forEach(p => {
                        propNotes[p.id] = p.notes ? [p.notes] : [];
                    });
                    
                    (clientsData.data || []).forEach(c => {
                        cliNotes[c.id] = c.notes ? [c.notes] : [];
                    });

                    setPropertyNotes(propNotes);
                    setClientNotes(cliNotes);

                } catch (error) {
                    console.error('Error fetching data:', error);
                    alert('Error loading data: ' + error.message);
                }
                setLoading(false);
                setTimeout(() => lucide.createIcons(), 100);
            }

            // ===== SAVE PROPERTY =====
            async function handleSaveProperty(e) {
                e.preventDefault();
                try {
                    const { error } = await supabaseClient
                        .from('properties')
                        .insert([propForm]);
                    
                    if (error) throw error;
                    alert('‚úÖ Property added successfully!');
                    
                    setPropForm({
                        title: '',
                        price: '',
                        location: '',
                        type: 'Apartment',
                        bedrooms: 1,
                        bathrooms: 1,
                        size_sqm: '',
                        description: '',
                        owner_name: '',
                        owner_contact: ''
                    });
                    fetchAllData();
                } catch (error) {
                    console.error('Error saving property:', error);
                    alert('‚ùå Error: ' + error.message);
                }
            }

            // ===== SAVE CLIENT =====
            async function handleSaveClient(e) {
                e.preventDefault();
                try {
                    const { error } = await supabaseClient
                        .from('clients')
                        .insert([clientForm]);
                    
                    if (error) throw error;
                    alert('‚úÖ Client added successfully!');
                    
                    setClientForm({
                        name: '',
                        phone: '',
                        looking_for: 'Apartment',
                        preferred_location: '',
                        budget: '',
                        min_bedrooms: 1,
                        max_bedrooms: 3,
                        notes: ''
                    });
                    fetchAllData();
                } catch (error) {
                    console.error('Error saving client:', error);
                    alert('‚ùå Error: ' + error.message);
                }
            }

            // ===== ADD NOTE =====
            async function handleAddNote() {
                if (!newNote.trim() || !selectedEntity) return;

                try {
                    const notesArray = noteType === 'property' 
                        ? (propertyNotes[selectedEntity.id] || [])
                        : (clientNotes[selectedEntity.id] || []);

                    const updatedNotes = [...notesArray, newNote];
                    const allNotesText = updatedNotes.join(' | ');

                    const table = noteType === 'property' ? 'properties' : 'clients';
                    const { error } = await supabaseClient
                        .from(table)
                        .update({ notes: allNotesText })
                        .eq('id', selectedEntity.id);

                    if (error) throw error;

                    if (noteType === 'property') {
                        setPropertyNotes({ ...propertyNotes, [selectedEntity.id]: updatedNotes });
                    } else {
                        setClientNotes({ ...clientNotes, [selectedEntity.id]: updatedNotes });
                    }

                    setNewNote('');
                    alert('‚úÖ Note added!');
                } catch (error) {
                    console.error('Error adding note:', error);
                    alert('‚ùå Error: ' + error.message);
                }
            }

            // ===== DELETE ITEM =====
            async function handleDelete(id, table) {
                if (!confirm('Are you sure you want to delete this item?')) return;

                try {
                    const { error } = await supabaseClient
                        .from(table)
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    alert('‚úÖ Deleted successfully!');
                    fetchAllData();
                } catch (error) {
                    console.error('Error deleting:', error);
                    alert('‚ùå Error: ' + error.message);
                }
            }

            // ===== INSTALL BANNER =====
            useEffect(() => {
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    setTimeout(() => setShowInstallBanner(true), 3000);
                };
                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                return () => window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
            }, []);

            // ===== RENDER =====
            return (
                <div className="flex h-full w-full">
                    {/* SIDEBAR */}
                    <div className="sidebar w-64 flex flex-col p-6">
                        <div className="mb-8">
                            <h1 className="text-2xl font-bold text-orange-500">Malta RE PRO</h1>
                            <p className="text-sm text-gray-400 mt-1">Real Estate Management</p>
                        </div>

                        <nav className="flex-1">
                            <button
                                onClick={() => setActiveTab('dashboard')}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 transition ${
                                    activeTab === 'dashboard' ? 'tab-active' : 'hover:bg-slate-700'
                                }`}
                            >
                                <i data-lucide="layout-dashboard" className="w-5 h-5"></i>
                                <span>Dashboard</span>
                            </button>

                            <button
                                onClick={() => setActiveTab('properties')}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 transition ${
                                    activeTab === 'properties' ? 'tab-active' : 'hover:bg-slate-700'
                                }`}
                            >
                                <i data-lucide="home" className="w-5 h-5"></i>
                                <span>Properties</span>
                            </button>

                            <button
                                onClick={() => setActiveTab('clients')}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 transition ${
                                    activeTab === 'clients' ? 'tab-active' : 'hover:bg-slate-700'
                                }`}
                            >
                                <i data-lucide="users" className="w-5 h-5"></i>
                                <span>Clients</span>
                            </button>

                            <button
                                onClick={() => setActiveTab('matches')}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 transition ${
                                    activeTab === 'matches' ? 'tab-active' : 'hover:bg-slate-700'
                                }`}
                            >
                                <i data-lucide="git-merge" className="w-5 h-5"></i>
                                <span>Smart Matches</span>
                                {matches.length > 0 && (
                                    <span className="ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded-full">
                                        {matches.length}
                                    </span>
                                )}
                            </button>

                            <button
                                onClick={() => setActiveTab('add-property')}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 transition ${
                                    activeTab === 'add-property' ? 'tab-active' : 'hover:bg-slate-700'
                                }`}
                            >
                                <i data-lucide="plus-circle" className="w-5 h-5"></i>
                                <span>Add Property</span>
                            </button>

                            <button
                                onClick={() => setActiveTab('add-client')}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 transition ${
                                    activeTab === 'add-client' ? 'tab-active' : 'hover:bg-slate-700'
                                }`}
                            >
                                <i data-lucide="user-plus" className="w-5 h-5"></i>
                                <span>Add Client</span>
                            </button>
                        </nav>

                        <div className="mt-auto pt-6 border-t border-slate-700">
                            <div className="text-xs text-gray-500">
                                <p>Properties: {properties.length}</p>
                                <p>Clients: {clients.length}</p>
                                <p>Matches: {matches.length}</p>
                            </div>
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 overflow-auto p-8">
                        {/* Install Banner */}
                        {showInstallBanner && (
                            <div className="glass mb-6 p-4 rounded-lg flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <i data-lucide="smartphone" className="w-6 h-6 text-orange-500"></i>
                                    <div>
                                        <h3 className="font-semibold">Install Malta RE PRO</h3>
                                        <p className="text-sm text-gray-400">Install this app for quick access</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => setShowInstallBanner(false)}
                                        className="px-4 py-2 rounded-lg hover:bg-slate-700 transition"
                                    >
                                        Later
                                    </button>
                                    <button 
                                        onClick={() => window.location.reload()}
                                        className="btn-primary px-4 py-2 rounded-lg text-white"
                                    >
                                        Install Now
                                    </button>
                                </div>
                            </div>
                        )}

                        {loading ? (
                            <div className="flex items-center justify-center h-64">
                                <div className="loading-spinner"></div>
                            </div>
                        ) : (
                            <>
                                {/* DASHBOARD */}
                                {activeTab === 'dashboard' && (
                                    <Dashboard 
                                        properties={properties} 
                                        clients={clients} 
                                        matches={matches}
                                    />
                                )}

                                {/* PROPERTIES */}
                                {activeTab === 'properties' && (
                                    <PropertiesList 
                                        properties={properties}
                                        propertyNotes={propertyNotes}
                                        onDelete={handleDelete}
                                        onAddNote={(prop) => {
                                            setSelectedEntity(prop);
                                            setNoteType('property');
                                            setActiveTab('add-note');
                                        }}
                                    />
                                )}

                                {/* CLIENTS */}
                                {activeTab === 'clients' && (
                                    <ClientsList 
                                        clients={clients}
                                        clientNotes={clientNotes}
                                        onDelete={handleDelete}
                                        onAddNote={(client) => {
                                            setSelectedEntity(client);
                                            setNoteType('client');
                                            setActiveTab('add-note');
                                        }}
                                    />
                                )}

                                {/* MATCHES */}
                                {activeTab === 'matches' && (
                                    <MatchesList matches={matches} />
                                )}

                                {/* ADD PROPERTY */}
                                {activeTab === 'add-property' && (
                                    <AddPropertyForm 
                                        form={propForm}
                                        setForm={setPropForm}
                                        onSubmit={handleSaveProperty}
                                    />
                                )}

                                {/* ADD CLIENT */}
                                {activeTab === 'add-client' && (
                                    <AddClientForm 
                                        form={clientForm}
                                        setForm={setClientForm}
                                        onSubmit={handleSaveClient}
                                    />
                                )}

                                {/* ADD NOTE */}
                                {activeTab === 'add-note' && selectedEntity && (
                                    <AddNote
                                        entity={selectedEntity}
                                        type={noteType}
                                        notes={noteType === 'property' ? propertyNotes[selectedEntity.id] : clientNotes[selectedEntity.id]}
                                        newNote={newNote}
                                        setNewNote={setNewNote}
                                        onSave={handleAddNote}
                                        onBack={() => setActiveTab(noteType === 'property' ? 'properties' : 'clients')}
                                    />
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // ===== DASHBOARD COMPONENT =====
        function Dashboard({ properties, clients, matches }) {
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-8">Dashboard</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div className="glass rounded-xl p-6">
                            <div className="flex items-center justify-between mb-4">
                                <i data-lucide="home" className="w-8 h-8 text-orange-500"></i>
                                <span className="text-3xl font-bold">{properties.length}</span>
                            </div>
                            <h3 className="text-lg font-semibold">Properties</h3>
                            <p className="text-sm text-gray-400">Active listings</p>
                        </div>

                        <div className="glass rounded-xl p-6">
                            <div className="flex items-center justify-between mb-4">
                                <i data-lucide="users" className="w-8 h-8 text-teal-500"></i>
                                <span className="text-3xl font-bold">{clients.length}</span>
                            </div>
                            <h3 className="text-lg font-semibold">Clients</h3>
                            <p className="text-sm text-gray-400">Active buyers</p>
                        </div>

                        <div className="glass rounded-xl p-6">
                            <div className="flex items-center justify-between mb-4">
                                <i data-lucide="git-merge" className="w-8 h-8 text-green-500"></i>
                                <span className="text-3xl font-bold">{matches.length}</span>
                            </div>
                            <h3 className="text-lg font-semibold">Smart Matches</h3>
                            <p className="text-sm text-gray-400">Potential deals</p>
                        </div>
                    </div>

                    <div className="glass rounded-xl p-6">
                        <h3 className="text-xl font-bold mb-4">Top Matches</h3>
                        {matches.slice(0, 5).map((match, idx) => (
                            <div key={idx} className="flex items-center justify-between p-4 mb-3 card rounded-lg">
                                <div className="flex-1">
                                    <h4 className="font-semibold">{match.property.title}</h4>
                                    <p className="text-sm text-gray-400">{match.client.name}</p>
                                </div>
                                <div className="match-score text-white px-4 py-2 rounded-lg">
                                    {match.score}% Match
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // ===== PROPERTIES LIST =====
        function PropertiesList({ properties, propertyNotes, onDelete, onAddNote }) {
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-8">Properties</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {properties.map(prop => (
                            <div key={prop.id} className="card rounded-xl p-6">
                                <div className="flex justify-between items-start mb-4">
                                    <h3 className="text-lg font-bold">{prop.title}</h3>
                                    <span className="text-orange-500 font-bold">‚Ç¨{Number(prop.price).toLocaleString()}</span>
                                </div>

                                <div className="space-y-2 mb-4">
                                    <div className="flex items-center gap-2 text-sm text-gray-400">
                                        <i data-lucide="map-pin" className="w-4 h-4"></i>
                                        <span>{prop.location}</span>
                                    </div>
                                    <div className="flex items-center gap-2 text-sm text-gray-400">
                                        <i data-lucide="home" className="w-4 h-4"></i>
                                        <span>{prop.type} ‚Ä¢ {prop.bedrooms} beds ‚Ä¢ {prop.bathrooms} baths</span>
                                    </div>
                                    {prop.size_sqm && (
                                        <div className="flex items-center gap-2 text-sm text-gray-400">
                                            <i data-lucide="maximize" className="w-4 h-4"></i>
                                            <span>{prop.size_sqm} m¬≤</span>
                                        </div>
                                    )}
                                </div>

                                {propertyNotes[prop.id] && propertyNotes[prop.id].length > 0 && (
                                    <div className="note-summary p-3 rounded-lg mb-4">
                                        <p className="text-xs font-semibold text-blue-400 mb-1">Summary</p>
                                        <p className="text-sm">{summarizeNotes(propertyNotes[prop.id])}</p>
                                    </div>
                                )}

                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => onAddNote(prop)}
                                        className="flex-1 btn-secondary text-white px-4 py-2 rounded-lg text-sm"
                                    >
                                        Add Note
                                    </button>
                                    <button 
                                        onClick={() => onDelete(prop.id, 'properties')}
                                        className="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600"
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // ===== CLIENTS LIST =====
        function ClientsList({ clients, clientNotes, onDelete, onAddNote }) {
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-8">Clients</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {clients.map(client => (
                            <div key={client.id} className="card rounded-xl p-6">
                                <div className="flex justify-between items-start mb-4">
                                    <h3 className="text-lg font-bold">{client.name}</h3>
                                    <span className="text-teal-500 font-bold">‚Ç¨{Number(client.budget).toLocaleString()}</span>
                                </div>

                                <div className="space-y-2 mb-4">
                                    <div className="flex items-center gap-2 text-sm text-gray-400">
                                        <i data-lucide="phone" className="w-4 h-4"></i>
                                        <span>{client.phone}</span>
                                    </div>
                                    <div className="flex items-center gap-2 text-sm text-gray-400">
                                        <i data-lucide="map-pin" className="w-4 h-4"></i>
                                        <span>{client.preferred_location}</span>
                                    </div>
                                    <div className="flex items-center gap-2 text-sm text-gray-400">
                                        <i data-lucide="home" className="w-4 h-4"></i>
                                        <span>{client.looking_for} ‚Ä¢ {client.min_bedrooms}+ beds</span>
                                    </div>
                                </div>

                                {clientNotes[client.id] && clientNotes[client.id].length > 0 && (
                                    <div className="note-summary p-3 rounded-lg mb-4">
                                        <p className="text-xs font-semibold text-blue-400 mb-1">Summary</p>
                                        <p className="text-sm">{summarizeNotes(clientNotes[client.id])}</p>
                                    </div>
                                )}

                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => onAddNote(client)}
                                        className="flex-1 btn-secondary text-white px-4 py-2 rounded-lg text-sm"
                                    >
                                        Add Note
                                    </button>
                                    <button 
                                        onClick={() => onDelete(client.id, 'clients')}
                                        className="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600"
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // ===== MATCHES LIST =====
        function MatchesList({ matches }) {
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-8">Smart Matches</h2>
                    
                    <div className="space-y-6">
                        {matches.map((match, idx) => (
                            <div key={idx} className="card rounded-xl p-6">
                                <div className="flex items-start justify-between mb-4">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-3 mb-2">
                                            <h3 className="text-xl font-bold">{match.property.title}</h3>
                                            <span className="match-score text-white px-3 py-1 rounded-full text-sm">
                                                {match.score}% Match
                                            </span>
                                        </div>
                                        <p className="text-gray-400">{match.client.name}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-2xl font-bold text-orange-500">‚Ç¨{Number(match.property.price).toLocaleString()}</p>
                                        <p className="text-sm text-gray-400">Budget: ‚Ç¨{Number(match.client.budget).toLocaleString()}</p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                    <div>
                                        <h4 className="font-semibold mb-2 text-orange-500">Property Details</h4>
                                        <div className="space-y-1 text-sm text-gray-400">
                                            <p>üìç {match.property.location}</p>
                                            <p>üè† {match.property.type}</p>
                                            <p>üõèÔ∏è {match.property.bedrooms} beds ‚Ä¢ {match.property.bathrooms} baths</p>
                                            {match.property.size_sqm && <p>üìê {match.property.size_sqm} m¬≤</p>}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 className="font-semibold mb-2 text-teal-500">Client Requirements</h4>
                                        <div className="space-y-1 text-sm text-gray-400">
                                            <p>üìû {match.client.phone}</p>
                                            <p>üìç Prefers {match.client.preferred_location}</p>
                                            <p>üè† Looking for {match.client.looking_for}</p>
                                            <p>üõèÔ∏è {match.client.min_bedrooms}+ bedrooms</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-green-500 bg-opacity-10 border border-green-500 rounded-lg p-4">
                                    <h4 className="font-semibold mb-2 text-green-500">Match Reasons</h4>
                                    <ul className="space-y-1 text-sm">
                                        {match.reasons.map((reason, i) => (
                                            <li key={i} className="flex items-start gap-2">
                                                <span className="text-green-500">‚úì</span>
                                                <span>{reason}</span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </div>
                        ))}

                        {matches.length === 0 && (
                            <div className="text-center py-12 text-gray-400">
                                <i data-lucide="search-x" className="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                                <p>No matches found. Add more properties and clients to see matches.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ===== ADD PROPERTY FORM =====
        function AddPropertyForm({ form, setForm, onSubmit }) {
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-8">Add Property</h2>
                    
                    <form onSubmit={onSubmit} className="glass rounded-xl p-8 max-w-2xl">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="md:col-span-2">
                                <label className="block text-sm font-semibold mb-2">Property Title *</label>
                                <input
                                    type="text"
                                    required
                                    value={form.title}
                                    onChange={e => setForm({...form, title: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                    placeholder="e.g., Modern Apartment in Sliema"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Price (‚Ç¨) *</label>
                                <input
                                    type="number"
                                    required
                                    value={form.price}
                                    onChange={e => setForm({...form, price: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                    placeholder="350000"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Location *</label>
                                <input
                                    type="text"
                                    required
                                    value={form.location}
                                    onChange={e => setForm({...form, location: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                    placeholder="Sliema"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Type *</label>
                                <select
                                    value={form.type}
                                    onChange={e => setForm({...form, type: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                >
                                    <option>Apartment</option>
                                    <option>House</option>
                                    <option>Villa</option>
                                    <option>Commercial</option>
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Bedrooms *</label>
                                <input
                                    type="number"
                                    required
                                    min="1"
                                    value={form.bedrooms}
                                    onChange={e => setForm({...form, bedrooms: parseInt(e.target.value)})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Bathrooms</label>
                                <input
                                    type="number"
                                    min="1"
                                    value={form.bathrooms}
                                    onChange={e => setForm({...form, bathrooms: parseInt(e.target.value)})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Size (m¬≤)</label>
                                <input
                                    type="number"
                                    value={form.size_sqm}
                                    onChange={e => setForm({...form, size_sqm: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                    placeholder="120"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Owner Name</label>
                                <input
                                    type="text"
                                    value={form.owner_name}
                                    onChange={e => setForm({...form, owner_name: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                    placeholder="John Doe"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Owner Contact</label>
                                <input
                                    type="text"
                                    value={form.owner_contact}
                                    onChange={e => setForm({...form, owner_contact: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                    placeholder="+356 9999 0000"
                                />
                            </div>

                            <div className="md:col-span-2">
                                <label className="block text-sm font-semibold mb-2">Description</label>
                                <textarea
                                    value={form.description}
                                    onChange={e => setForm({...form, description: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                    rows="4"
                                    placeholder="Beautiful property with sea views..."
                                ></textarea>
                            </div>
                        </div>

                        <button
                            type="submit"
                            className="btn-primary w-full mt-6 px-6 py-3 rounded-lg text-white font-semibold"
                        >
                            Add Property
                        </button>
                    </form>
                </div>
            );
        }

        // ===== ADD CLIENT FORM =====
        function AddClientForm({ form, setForm, onSubmit }) {
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-8">Add Client</h2>
                    
                    <form onSubmit={onSubmit} className="glass rounded-xl p-8 max-w-2xl">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label className="block text-sm font-semibold mb-2">Name *</label>
                                <input
                                    type="text"
                                    required
                                    value={form.name}
                                    onChange={e => setForm({...form, name: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                    placeholder="John Smith"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Phone *</label>
                                <input
                                    type="tel"
                                    required
                                    value={form.phone}
                                    onChange={e => setForm({...form, phone: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                    placeholder="+356 9999 1111"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Looking For *</label>
                                <select
                                    value={form.looking_for}
                                    onChange={e => setForm({...form, looking_for: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                >
                                    <option>Apartment</option>
                                    <option>House</option>
                                    <option>Villa</option>
                                    <option>Commercial</option>
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Preferred Location *</label>
                                <input
                                    type="text"
                                    required
                                    value={form.preferred_location}
                                    onChange={e => setForm({...form, preferred_location: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                    placeholder="Sliema"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Budget (‚Ç¨) *</label>
                                <input
                                    type="number"
                                    required
                                    value={form.budget}
                                    onChange={e => setForm({...form, budget: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                    placeholder="380000"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Min Bedrooms *</label>
                                <input
                                    type="number"
                                    required
                                    min="1"
                                    value={form.min_bedrooms}
                                    onChange={e => setForm({...form, min_bedrooms: parseInt(e.target.value)})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Max Bedrooms</label>
                                <input
                                    type="number"
                                    min="1"
                                    value={form.max_bedrooms}
                                    onChange={e => setForm({...form, max_bedrooms: parseInt(e.target.value)})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                />
                            </div>

                            <div className="md:col-span-2">
                                <label className="block text-sm font-semibold mb-2">Notes</label>
                                <textarea
                                    value={form.notes}
                                    onChange={e => setForm({...form, notes: e.target.value})}
                                    className="input-field w-full px-4 py-3 rounded-lg"
                                    rows="4"
                                    placeholder="Additional information about the client..."
                                ></textarea>
                            </div>
                        </div>

                        <button
                            type="submit"
                            className="btn-primary w-full mt-6 px-6 py-3 rounded-lg text-white font-semibold"
                        >
                            Add Client
                        </button>
                    </form>
                </div>
            );
        }

        // ===== ADD NOTE COMPONENT =====
        function AddNote({ entity, type, notes, newNote, setNewNote, onSave, onBack }) {
            return (
                <div>
                    <div className="flex items-center gap-4 mb-8">
                        <button 
                            onClick={onBack}
                            className="p-2 hover:bg-slate-700 rounded-lg transition"
                        >
                            <i data-lucide="arrow-left" className="w-6 h-6"></i>
                        </button>
                        <h2 className="text-3xl font-bold">
                            Add Note - {type === 'property' ? entity.title : entity.name}
                        </h2>
                    </div>

                    <div className="glass rounded-xl p-8 max-w-2xl">
                        {notes && notes.length > 0 && (
                            <div className="mb-6">
                                <h3 className="font-semibold mb-3">Previous Notes</h3>
                                <div className="space-y-2">
                                    {notes.map((note, idx) => (
                                        <div key={idx} className="bg-slate-700 p-3 rounded-lg text-sm">
                                            {note}
                                        </div>
                                    ))}
                                </div>
                                <div className="note-summary p-4 rounded-lg mt-4">
                                    <p className="text-xs font-semibold text-blue-400 mb-1">AI Summary</p>
                                    <p className="text-sm">{summarizeNotes(notes)}</p>
                                </div>
                            </div>
                        )}

                        <div>
                            <label className="block text-sm font-semibold mb-2">Add New Note</label>
                            <textarea
                                value={newNote}
                                onChange={e => setNewNote(e.target.value)}
                                className="input-field w-full px-4 py-3 rounded-lg"
                                rows="4"
                                placeholder="Type your note here..."
                            ></textarea>
                        </div>

                        <button
                            onClick={onSave}
                            className="btn-primary w-full mt-4 px-6 py-3 rounded-lg text-white font-semibold"
                        >
                            Save Note
                        </button>
                    </div>
                </div>
            );
        }

        // ===== INITIALIZE APP =====
        ReactDOM.render(<App />, document.getElementById('root'));

        // ===== SERVICE WORKER REGISTRATION =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('‚úÖ Service Worker registered'))
                    .catch(err => console.log('‚ùå Service Worker registration failed:', err));
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malta Real Estate PRO v5</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f97316">
    <link rel="icon" type="image/png" href="./icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body, #root { width: 100%; height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #e2e8f0; }
        .sidebar { background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); border-right: 1px solid rgba(148, 163, 184, 0.1); }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(148, 163, 184, 0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .tab-active { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4); }
        .btn-primary { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4); transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(249, 115, 22, 0.6); }
        .card { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); transition: all 0.3s ease; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.3); border-color: rgba(249, 115, 22, 0.3); }
        .input-field { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); color: #e2e8f0; transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: #f97316; box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1); }
        .priority-high { background: #dc2626; }
        .priority-medium { background: #f59e0b; }
        .priority-low { background: #10b981; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        const SUPABASE_URL = 'https://xevlfdjyvhhnyvxtwzsb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhldmxmZGp5dmhobnl2eHR3enNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDQyODgsImV4cCI6MjA4NTg4MDI4OH0.vf9y_5h7jBKLEWP3AcGx3bvKZObukIXoHYLtdY42pwM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const MALTA_CITIES = ['Valletta', 'Sliema', 'St. Julians', 'Gzira', 'Msida', 'Birkirkara', 'Qormi', 'Mosta', 'Zabbar', 'Mellieha', 'St. Pauls Bay', 'Swieqi', 'Naxxar', 'Fgura', 'Zejtun', 'Hamrun', 'Vittoriosa', 'Cospicua', 'Senglea', 'Floriana', 'Paola', 'Tarxien', 'Marsa', 'Luqa', 'Gudja'];
        
        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [currentUser, setCurrentUser] = useState('Gabriel QL');
            const [properties, setProperties] = useState([]);
            const [clients, setClients] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [viewings, setViewings] = useState([]);
            const [communications, setCommunications] = useState([]);
            const [deals, setDeals] = useState([]);
            const [notes, setNotes] = useState([]);
            const [editingProperty, setEditingProperty] = useState(null);
            const [editingClient, setEditingClient] = useState(null);
            
            const [propForm, setPropForm] = useState({ reference_number: '', type: 'Apartment', bedrooms: 1, available_from: '', price_per_month: '', negotiable: false, location: '', notes: '' });
            const [clientForm, setClientForm] = useState({ name: '', phone: '', looking_for: ['Apartment'], locations: ['Sliema'], moving_date: '', nationality: '', occupation: '', how_many_people: 1, pets: false, let_type: 'Long Let', budget: '', min_bedrooms: 1, max_bedrooms: 3, other_requirements: '', notes: '' });
            
            useEffect(() => {
                fetchAll();
                requestNotificationPermission();
                checkReminders();
                const interval = setInterval(checkReminders, 30000); // Check every 30 seconds
                return () => clearInterval(interval);
            }, []);
            
            async function fetchAll() {
                const [p, c, t, v, cm, d, n] = await Promise.all([
                    supabaseClient.from('properties').select('*').order('created_at', { ascending: false }),
                    supabaseClient.from('clients').select('*').order('created_at', { ascending: false }),
                    supabaseClient.from('tasks').select('*').order('due_date', { ascending: true }),
                    supabaseClient.from('viewings').select('*, properties(*), clients(*)').order('scheduled_date', { ascending: true }),
                    supabaseClient.from('communications').select('*, properties(*), clients(*)').order('created_at', { ascending: false }),
                    supabaseClient.from('deals').select('*, properties(*), clients(*)').order('created_at', { ascending: false }),
                    supabaseClient.from('daily_notes').select('*').order('created_at', { ascending: false })
                ]);
                if (p.data) setProperties(p.data);
                if (c.data) setClients(c.data);
                if (t.data) setTasks(t.data);
                if (v.data) setViewings(v.data);
                if (cm.data) setCommunications(cm.data);
                if (d.data) setDeals(d.data);
                if (n.data) setNotes(n.data);
            }
            
            function requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }
            
            async function checkReminders() {
                const now = new Date();
                const { data } = await supabaseClient
                    .from('reminders')
                    .select('*, tasks(*), viewings(*, properties(*), clients(*))')
                    .eq('dismissed', false)
                    .lte('remind_at', now.toISOString());
                
                if (data && data.length > 0) {
                    data.forEach(r => {
                        if (Notification.permission === 'granted') {
                            new Notification('üîî Malta RE PRO', { 
                                body: r.title + (r.message ? '\n' + r.message : ''), 
                                icon: './icon-192.png',
                                requireInteraction: true
                            });
                        } else {
                            alert('üîî Reminder: ' + r.title);
                        }
                        supabaseClient.from('reminders').update({ dismissed: true }).eq('id', r.id);
                    });
                }
            }
            
            const matches = useMemo(() => {
                let all = [];
                properties.forEach(p => {
                    clients.forEach(c => {
                        const priceDiff = Math.abs(p.price_per_month - c.budget);
                        let priceMatch;
                        if (priceDiff === 0) {
                            priceMatch = 100;
                        } else if (p.negotiable && priceDiff <= 100) {
                            priceMatch = 100;
                        } else if (priceDiff <= 100) {
                            priceMatch = 100 - (priceDiff);
                        } else if (p.negotiable && priceDiff <= 200) {
                            priceMatch = 100 - (priceDiff / 2);
                        } else {
                            priceMatch = Math.max(0, 100 - (priceDiff / c.budget * 100));
                        }
                        const locMatch = c.locations.includes(p.location) ? 100 : 0;
                        const typeMatch = c.looking_for.includes(p.type) ? 100 : 0;
                        const bedMatch = p.bedrooms >= c.min_bedrooms && p.bedrooms <= (c.max_bedrooms || 99) ? 100 : 0;
                        const total = (priceMatch * 0.4 + locMatch * 0.3 + typeMatch * 0.2 + bedMatch * 0.1);
                        if (total >= 40) all.push({ property: p, client: c, scores: { price: priceMatch, location: locMatch, type: typeMatch, beds: bedMatch, total, priceDiff } });
                    });
                });
                return all.sort((a, b) => b.scores.total - a.scores.total);
            }, [properties, clients]);
            
            async function saveProperty(e) {
                e.preventDefault();
                const data = { ...propForm, added_by: currentUser };
                const { error } = editingProperty 
                    ? await supabaseClient.from('properties').update(data).eq('id', editingProperty.id)
                    : await supabaseClient.from('properties').insert([data]);
                if (error) return alert('‚ùå ' + error.message);
                alert('‚úÖ Property ' + (editingProperty ? 'updated' : 'added'));
                setPropForm({ reference_number: '', type: 'Apartment', bedrooms: 1, available_from: '', price_per_month: '', negotiable: false, location: '', notes: '' });
                setEditingProperty(null);
                fetchAll();
                setActiveTab('properties');
            }
            
            async function saveClient(e) {
                e.preventDefault();
                const data = { ...clientForm, added_by: currentUser };
                const { error } = editingClient
                    ? await supabaseClient.from('clients').update(data).eq('id', editingClient.id)
                    : await supabaseClient.from('clients').insert([data]);
                if (error) return alert('‚ùå ' + error.message);
                alert('‚úÖ Client ' + (editingClient ? 'updated' : 'added'));
                setClientForm({ name: '', phone: '', looking_for: ['Apartment'], locations: ['Sliema'], moving_date: '', nationality: '', occupation: '', how_many_people: 1, pets: false, let_type: 'Long Let', budget: '', min_bedrooms: 1, max_bedrooms: 3, other_requirements: '', notes: '' });
                setEditingClient(null);
                fetchAll();
                setActiveTab('clients');
            }
            
            async function deleteItem(table, id) {
                if (!confirm('Delete?')) return;
                await supabaseClient.from(table).delete().eq('id', id);
                fetchAll();
            }
            
            async function saveTask(title, priority, category, dueDate) {
                await supabaseClient.from('tasks').insert([{ title, priority, category, due_date: dueDate, added_by: currentUser }]);
                await supabaseClient.from('reminders').insert([{ title: `Task: ${title}`, remind_at: dueDate, type: 'task', added_by: currentUser }]);
                fetchAll();
            }
            
            async function toggleTask(id, completed) {
                await supabaseClient.from('tasks').update({ completed, completed_at: completed ? new Date().toISOString() : null }).eq('id', id);
                fetchAll();
            }
            
            async function saveViewing(propId, clientId, date) {
                const { data } = await supabaseClient.from('viewings').insert([{ property_id: propId, client_id: clientId, scheduled_date: date, added_by: currentUser }]).select();
                if (data && data[0]) {
                    const reminderTime = new Date(new Date(date).getTime() - 60 * 60 * 1000);
                    await supabaseClient.from('reminders').insert([{ title: `Viewing in 1 hour`, remind_at: reminderTime, type: 'viewing', viewing_id: data[0].id, added_by: currentUser }]);
                }
                fetchAll();
            }
            
            async function saveCommunication(type, content, propId, clientId) {
                await supabaseClient.from('communications').insert([{ type, content, property_id: propId, client_id: clientId, added_by: currentUser }]);
                fetchAll();
            }
            
            async function saveDeal(propId, clientId, value, commission) {
                await supabaseClient.from('deals').insert([{ property_id: propId, client_id: clientId, deal_value: value, commission_percent: commission, added_by: currentUser }]);
                fetchAll();
            }
            
            return (
                <div className="flex h-screen">
                    {/* Sidebar */}
                    <div className="sidebar w-64 flex-shrink-0 p-4 overflow-y-auto">
                        <div className="mb-6">
                            <h1 className="text-2xl font-bold text-orange-500">Malta RE PRO v5</h1>
                            <select value={currentUser} onChange={e => setCurrentUser(e.target.value)} className="input-field w-full mt-2 p-2 rounded">
                                <option>Gabriel QL</option>
                                <option>Georgiana QL</option>
                            </select>
                        </div>
                        <nav className="space-y-2">
                            {['dashboard', 'add-property', 'properties', 'add-client', 'clients', 'tasks', 'viewings', 'communications', 'matches', 'deals', 'stats'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`w-full p-3 rounded text-left ${activeTab === tab ? 'tab-active' : 'hover:bg-slate-700'}`}>
                                    {tab.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                </button>
                            ))}
                        </nav>
                    </div>
                    
                    {/* Main */}
                    <div className="flex-1 overflow-y-auto p-6">
                        {activeTab === 'dashboard' && <Dashboard properties={properties} clients={clients} tasks={tasks} viewings={viewings} deals={deals} notes={notes} />}
                        {activeTab === 'add-property' && <AddProperty form={propForm} setForm={setPropForm} save={saveProperty} editing={editingProperty} setEditing={setEditingProperty} />}
                        {activeTab === 'properties' && <Properties items={properties} onEdit={p => { setEditingProperty(p); setPropForm(p); setActiveTab('add-property'); }} onDelete={id => deleteItem('properties', id)} />}
                        {activeTab === 'add-client' && <AddClient form={clientForm} setForm={setClientForm} save={saveClient} editing={editingClient} setEditing={setEditingClient} />}
                        {activeTab === 'clients' && <Clients items={clients} onEdit={c => { setEditingClient(c); setClientForm(c); setActiveTab('add-client'); }} onDelete={id => deleteItem('clients', id)} onLog={saveCommunication} />}
                        {activeTab === 'tasks' && <Tasks items={tasks} onSave={saveTask} onToggle={toggleTask} onDelete={id => deleteItem('tasks', id)} />}
                        {activeTab === 'viewings' && <Viewings items={viewings} properties={properties} clients={clients} onSave={saveViewing} />}
                        {activeTab === 'communications' && <Communications items={communications} />}
                        {activeTab === 'matches' && <Matches items={matches} />}
                        {activeTab === 'deals' && <Deals items={deals} properties={properties} clients={clients} onSave={saveDeal} />}
                        {activeTab === 'stats' && <Stats properties={properties} clients={clients} deals={deals} />}
                    </div>
                </div>
            );
        }
        
        function Dashboard({ properties, clients, tasks, viewings, deals, notes }) {
            const todayTasks = tasks.filter(t => !t.completed && new Date(t.due_date) <= new Date(Date.now() + 86400000));
            const todayViewings = viewings.filter(v => v.status === 'scheduled' && new Date(v.scheduled_date).toDateString() === new Date().toDateString());
            return (
                <div className="space-y-6">
                    <h2 className="text-3xl font-bold">Dashboard</h2>
                    <div className="grid grid-cols-4 gap-4">
                        <div className="card p-4 rounded-lg"><div className="text-3xl font-bold text-orange-500">{properties.length}</div><div className="text-sm">Properties</div></div>
                        <div className="card p-4 rounded-lg"><div className="text-3xl font-bold text-blue-500">{clients.length}</div><div className="text-sm">Clients</div></div>
                        <div className="card p-4 rounded-lg"><div className="text-3xl font-bold text-green-500">{todayTasks.length}</div><div className="text-sm">Tasks Today</div></div>
                        <div className="card p-4 rounded-lg"><div className="text-3xl font-bold text-purple-500">{todayViewings.length}</div><div className="text-sm">Viewings Today</div></div>
                    </div>
                    {todayTasks.length > 0 && (
                        <div className="card p-4 rounded-lg">
                            <h3 className="font-bold mb-2">‚è∞ Tasks Due Today</h3>
                            {todayTasks.map(t => <div key={t.id} className="text-sm py-1">üî¥ {t.title}</div>)}
                        </div>
                    )}
                </div>
            );
        }
        
        function AddProperty({ form, setForm, save, editing, setEditing }) {
            return (
                <div className="max-w-2xl">
                    <h2 className="text-3xl font-bold mb-6">{editing ? '‚úèÔ∏è Edit' : '‚ûï Add'} Property</h2>
                    <form onSubmit={save} className="space-y-4">
                        <input required value={form.reference_number} onChange={e => setForm({...form, reference_number: e.target.value})} placeholder="REF-001" className="input-field w-full p-3 rounded" />
                        <select value={form.type} onChange={e => setForm({...form, type: e.target.value})} className="input-field w-full p-3 rounded">
                            {['Apartment', 'Penthouse', 'House', 'Duplex', 'Studio', 'Maisonette', 'Villa', 'Townhouse', 'Farmhouse'].map(t => <option key={t}>{t}</option>)}
                        </select>
                        <input required type="number" value={form.bedrooms} onChange={e => setForm({...form, bedrooms: parseInt(e.target.value)})} placeholder="Bedrooms" className="input-field w-full p-3 rounded" />
                        <input required type="date" value={form.available_from} onChange={e => setForm({...form, available_from: e.target.value})} className="input-field w-full p-3 rounded" />
                        <input required type="number" value={form.price_per_month} onChange={e => setForm({...form, price_per_month: e.target.value})} placeholder="Price ‚Ç¨" className="input-field w-full p-3 rounded" />
                        <label className="flex items-center gap-2"><input type="checkbox" checked={form.negotiable} onChange={e => setForm({...form, negotiable: e.target.checked})} /> Negotiable</label>
                        <input required list="cities" value={form.location} onChange={e => setForm({...form, location: e.target.value})} placeholder="Location" className="input-field w-full p-3 rounded" />
                        <datalist id="cities">{MALTA_CITIES.map(c => <option key={c} value={c} />)}</datalist>
                        <textarea value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} placeholder="Notes" className="input-field w-full p-3 rounded" rows="3" />
                        <div className="flex gap-2">
                            <button type="submit" className="btn-primary px-6 py-3 rounded text-white font-semibold">{editing ? 'üíæ Update' : '‚ûï Add'}</button>
                            {editing && <button type="button" onClick={() => setEditing(null)} className="px-6 py-3 rounded bg-gray-600">‚ùå Cancel</button>}
                        </div>
                    </form>
                </div>
            );
        }
        
        function Properties({ items, onEdit, onDelete }) {
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">Properties ({items.length})</h2>
                    <div className="grid gap-4">
                        {items.map(p => (
                            <div key={p.id} className="card p-4 rounded-lg">
                                <div className="flex justify-between items-start">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-lg">{p.reference_number}</span>
                                            <span className="text-orange-500 font-bold">‚Ç¨{p.price_per_month}/mo</span>
                                            <span className={`text-xs px-2 py-1 rounded ${p.added_by === 'Gabriel QL' ? 'bg-blue-600' : 'bg-pink-600'}`}>{p.added_by}</span>
                                        </div>
                                        <div className="mt-2 text-sm">{p.type} ‚Ä¢ {p.bedrooms} beds ‚Ä¢ {p.location}</div>
                                        {p.notes && <div className="mt-2 text-sm text-gray-400">{p.notes}</div>}
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => onEdit(p)} className="px-3 py-1 bg-blue-600 rounded text-sm">‚úèÔ∏è Edit</button>
                                        <button onClick={() => onDelete(p.id)} className="px-3 py-1 bg-red-600 rounded text-sm">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        
        function AddClient({ form, setForm, save, editing, setEditing }) {
            return (
                <div className="max-w-2xl">
                    <h2 className="text-3xl font-bold mb-6">{editing ? '‚úèÔ∏è Edit' : '‚ûï Add'} Client</h2>
                    <form onSubmit={save} className="space-y-4">
                        <input required value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="Name" className="input-field w-full p-3 rounded" />
                        <input required type="tel" value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} placeholder="+356..." className="input-field w-full p-3 rounded" />
                        <input required type="date" value={form.moving_date} onChange={e => setForm({...form, moving_date: e.target.value})} className="input-field w-full p-3 rounded" />
                        <input value={form.nationality} onChange={e => setForm({...form, nationality: e.target.value})} placeholder="Nationality" className="input-field w-full p-3 rounded" />
                        <input value={form.occupation} onChange={e => setForm({...form, occupation: e.target.value})} placeholder="Occupation" className="input-field w-full p-3 rounded" />
                        <input type="number" value={form.how_many_people} onChange={e => setForm({...form, how_many_people: parseInt(e.target.value)})} placeholder="People" className="input-field w-full p-3 rounded" />
                        <input required type="number" value={form.budget} onChange={e => setForm({...form, budget: e.target.value})} placeholder="Budget ‚Ç¨" className="input-field w-full p-3 rounded" />
                        <button type="submit" className="btn-primary px-6 py-3 rounded text-white font-semibold">{editing ? 'üíæ Update' : '‚ûï Add'}</button>
                    </form>
                </div>
            );
        }
        
        function Clients({ items, onEdit, onDelete, onLog }) {
            const [selectedClient, setSelectedClient] = useState(null);
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">Clients ({items.length})</h2>
                    <div className="grid gap-4">
                        {items.map(c => (
                            <div key={c.id} className="card p-4 rounded-lg">
                                <div className="flex justify-between items-start">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-lg">{c.name}</span>
                                            <span className="text-teal-500 font-bold">‚Ç¨{c.budget}</span>
                                            <span className={`text-xs px-2 py-1 rounded ${c.added_by === 'Gabriel QL' ? 'bg-blue-600' : 'bg-pink-600'}`}>{c.added_by}</span>
                                        </div>
                                        <div className="mt-2 text-sm">{c.phone}</div>
                                        <div className="flex gap-2 mt-2">
                                            <a href={`tel:${c.phone}`} className="px-3 py-1 bg-green-600 rounded text-sm">üìû Call</a>
                                            <a href={`https://wa.me/${c.phone.replace(/[^0-9]/g, '')}`} target="_blank" className="px-3 py-1 bg-green-600 rounded text-sm">üí¨ WhatsApp</a>
                                            <button onClick={() => setSelectedClient(c)} className="px-3 py-1 bg-purple-600 rounded text-sm">üí¨ Log</button>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => onEdit(c)} className="px-3 py-1 bg-blue-600 rounded text-sm">‚úèÔ∏è Edit</button>
                                        <button onClick={() => onDelete(c.id)} className="px-3 py-1 bg-red-600 rounded text-sm">üóëÔ∏è</button>
                                    </div>
                                </div>
                                {selectedClient?.id === c.id && (
                                    <div className="mt-4 p-3 bg-slate-800 rounded">
                                        <select className="input-field p-2 rounded mb-2" id={`logType${c.id}`}><option>call</option><option>message</option><option>email</option></select>
                                        <textarea id={`logContent${c.id}`} placeholder="Notes..." className="input-field w-full p-2 rounded mb-2" />
                                        <button onClick={() => { onLog(document.getElementById(`logType${c.id}`).value, document.getElementById(`logContent${c.id}`).value, null, c.id); setSelectedClient(null); }} className="btn-primary px-4 py-2 rounded">Save Log</button>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        
        function Tasks({ items, onSave, onToggle, onDelete }) {
            const [showForm, setShowForm] = useState(false);
            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold">‚úÖ Tasks ({items.filter(t => !t.completed).length})</h2>
                        <button onClick={() => setShowForm(!showForm)} className="btn-primary px-4 py-2 rounded">‚ûï Add Task</button>
                    </div>
                    {showForm && (
                        <div className="card p-4 rounded-lg mb-4">
                            <input id="taskTitle" placeholder="Task title" className="input-field w-full p-2 rounded mb-2" />
                            <select id="taskPriority" className="input-field p-2 rounded mb-2"><option value="high">üî¥ High</option><option value="medium">üü° Medium</option><option value="low">üü¢ Low</option></select>
                            <select id="taskCategory" className="input-field p-2 rounded mb-2"><option value="follow-up">Follow-up</option><option value="viewing">Viewing</option><option value="contract">Contract</option><option value="general">General</option></select>
                            <input id="taskDue" type="datetime-local" className="input-field p-2 rounded mb-2" />
                            <button onClick={() => { 
                                const dueDate = new Date(document.getElementById('taskDue').value);
                                onSave(document.getElementById('taskTitle').value, document.getElementById('taskPriority').value, document.getElementById('taskCategory').value, dueDate.toISOString()); 
                                setShowForm(false); 
                            }} className="btn-primary px-4 py-2 rounded">Save</button>
                        </div>
                    )}
                    <div className="space-y-2">
                        {items.filter(t => !t.completed).map(t => (
                            <div key={t.id} className="card p-3 rounded flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <input type="checkbox" checked={t.completed} onChange={e => onToggle(t.id, e.target.checked)} />
                                    <div className={`w-2 h-2 rounded-full priority-${t.priority}`} />
                                    <div>{t.title}</div>
                                    <div className="text-sm text-gray-400">{new Date(t.due_date).toLocaleString()}</div>
                                </div>
                                <button onClick={() => onDelete(t.id)} className="text-red-500">üóëÔ∏è</button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        
        function Viewings({ items, properties, clients, onSave }) {
            const [showForm, setShowForm] = useState(false);
            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold">üìÖ Viewings ({items.filter(v => v.status === 'scheduled').length})</h2>
                        <button onClick={() => setShowForm(!showForm)} className="btn-primary px-4 py-2 rounded">‚ûï Schedule</button>
                    </div>
                    {showForm && (
                        <div className="card p-4 rounded-lg mb-4">
                            <select id="viewProp" className="input-field w-full p-2 rounded mb-2">{properties.map(p => <option key={p.id} value={p.id}>{p.reference_number}</option>)}</select>
                            <select id="viewClient" className="input-field w-full p-2 rounded mb-2">{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select>
                            <input id="viewDate" type="datetime-local" className="input-field p-2 rounded mb-2" />
                            <button onClick={() => { 
                                const viewDate = new Date(document.getElementById('viewDate').value);
                                onSave(document.getElementById('viewProp').value, document.getElementById('viewClient').value, viewDate.toISOString()); 
                                setShowForm(false); 
                            }} className="btn-primary px-4 py-2 rounded">Schedule</button>
                        </div>
                    )}
                    <div className="space-y-2">
                        {items.filter(v => v.status === 'scheduled').map(v => (
                            <div key={v.id} className="card p-3 rounded">
                                <div className="font-bold">{new Date(v.scheduled_date).toLocaleString()}</div>
                                <div className="text-sm">{v.clients?.name} ‚Üí {v.properties?.reference_number}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        
        function Communications({ items }) {
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">üí¨ Communications ({items.length})</h2>
                    <div className="space-y-2">
                        {items.map(c => (
                            <div key={c.id} className="card p-3 rounded">
                                <div className="flex items-center gap-2">
                                    <span className="text-xl">{c.type === 'call' ? 'üìû' : c.type === 'message' ? 'üí¨' : 'üìß'}</span>
                                    <span className="font-bold">{c.clients?.name || c.properties?.reference_number}</span>
                                    <span className="text-sm text-gray-400">{new Date(c.created_at).toLocaleString()}</span>
                                </div>
                                <div className="mt-2 text-sm">{c.content}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        
        function Matches({ items }) {
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">üéØ Smart Matches ({items.length})</h2>
                    <div className="space-y-4">
                        {items.map((m, i) => (
                            <div key={i} className="card p-4 rounded-lg">
                                <div className="flex justify-between items-start">
                                    <div className="flex-1">
                                        <div className="font-bold text-lg mb-2">{m.property.reference_number} ‚Üí {m.client.name}</div>
                                        <div className="text-sm text-gray-400 mb-2">
                                            Property: ‚Ç¨{m.property.price_per_month} | Client Budget: ‚Ç¨{m.client.budget} | Diff: ‚Ç¨{m.scores.priceDiff}
                                            {m.property.negotiable && <span className="ml-2 text-green-500">‚úì Negotiable</span>}
                                        </div>
                                        <div className="grid grid-cols-4 gap-2 text-sm">
                                            <div>Price: {Math.round(m.scores.price)}%</div>
                                            <div>Location: {Math.round(m.scores.location)}%</div>
                                            <div>Type: {Math.round(m.scores.type)}%</div>
                                            <div>Beds: {Math.round(m.scores.beds)}%</div>
                                        </div>
                                    </div>
                                    <div className="text-3xl font-bold text-green-500">{Math.round(m.scores.total)}%</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        
        function Deals({ items, properties, clients, onSave }) {
            const [showForm, setShowForm] = useState(false);
            const totalCommission = items.filter(d => d.status === 'closed').reduce((sum, d) => sum + parseFloat(d.commission_amount || 0), 0);
            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold">üí∞ Deals ({items.length})</h2>
                        <div className="text-2xl font-bold text-green-500">‚Ç¨{totalCommission.toFixed(2)} Commission</div>
                        <button onClick={() => setShowForm(!showForm)} className="btn-primary px-4 py-2 rounded">‚ûï Add Deal</button>
                    </div>
                    {showForm && (
                        <div className="card p-4 rounded-lg mb-4">
                            <select id="dealProp" className="input-field w-full p-2 rounded mb-2">{properties.map(p => <option key={p.id} value={p.id}>{p.reference_number}</option>)}</select>
                            <select id="dealClient" className="input-field w-full p-2 rounded mb-2">{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select>
                            <input id="dealValue" type="number" placeholder="Deal Value ‚Ç¨" className="input-field p-2 rounded mb-2" />
                            <input id="dealCommission" type="number" placeholder="Commission %" defaultValue="5" className="input-field p-2 rounded mb-2" />
                            <button onClick={() => { onSave(document.getElementById('dealProp').value, document.getElementById('dealClient').value, document.getElementById('dealValue').value, document.getElementById('dealCommission').value); setShowForm(false); }} className="btn-primary px-4 py-2 rounded">Add Deal</button>
                        </div>
                    )}
                    <div className="space-y-2">
                        {items.map(d => (
                            <div key={d.id} className="card p-3 rounded">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <div className="font-bold">{d.properties?.reference_number} ‚Üí {d.clients?.name}</div>
                                        <div className="text-sm">‚Ç¨{d.deal_value} ‚Ä¢ Commission: ‚Ç¨{d.commission_amount}</div>
                                    </div>
                                    <div className={`px-3 py-1 rounded ${d.status === 'closed' ? 'bg-green-600' : 'bg-yellow-600'}`}>{d.status}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        
        function Stats({ properties, clients, deals }) {
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">üìä Statistics</h2>
                    <div className="grid grid-cols-3 gap-4">
                        <div className="card p-4 rounded-lg"><div className="text-3xl font-bold text-orange-500">{properties.length}</div><div>Total Properties</div></div>
                        <div className="card p-4 rounded-lg"><div className="text-3xl font-bold text-blue-500">{clients.length}</div><div>Total Clients</div></div>
                        <div className="card p-4 rounded-lg"><div className="text-3xl font-bold text-green-500">{deals.filter(d => d.status === 'closed').length}</div><div>Closed Deals</div></div>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

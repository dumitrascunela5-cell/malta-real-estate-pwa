<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malta Real Estate PRO</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f97316">
    <link rel="icon" type="image/png" href="./icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #f1f5f9; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); }
        .tab-active { border-bottom: 3px solid #f97316; color: #f97316; font-weight: 700; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- CONFIGURARE SUPABASE ---
        const SUPABASE_URL = 'https://xevlfdjyvhhnyvxtwzsb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhldmxmZGp5dmhobnl2eHR3enNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDQyODgsImV4cCI6MjA4NTg4MDI4OH0.vf9y_5h7jBKLEWP3AcGx3bvKZObukIXoHYLtdY42pwM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function App() {
            const [activeTab, setActiveTab] = useState('properties');
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editingItem, setEditingItem] = useState(null);

            // Form States
            const [propForm, setPropForm] = useState({ title: '', price: '', location: '', type: 'Apartment', bedrooms: 1 });

            useEffect(() => {
                fetchData();
            }, [activeTab]);

            async function fetchData() {
                setLoading(true);
                const { data, error } = await supabaseClient.from(activeTab).select('*').order('created_at', { ascending: false });
                if (!error) setItems(data);
                setLoading(false);
                setTimeout(() => lucide.createIcons(), 100);
            }

            // --- CRUD ACTIONS ---
            async function handleSave(e) {
                e.preventDefault();
                if (editingItem) {
                    const { error } = await supabaseClient.from(activeTab).update(propForm).eq('id', editingItem.id);
                    if (!error) { alert('Actualizat!'); setEditingItem(null); }
                } else {
                    const { error } = await supabaseClient.from(activeTab).insert([propForm]);
                    if (!error) alert('AdƒÉugat cu succes!');
                }
                setPropForm({ title: '', price: '', location: '', type: 'Apartment', bedrooms: 1 });
                fetchData();
            }

            async function handleDelete(id) {
                if (confirm('Sigur vrei sƒÉ »ôtergi?')) {
                    const { error } = await supabaseClient.from(activeTab).delete().eq('id', id);
                    if (!error) fetchData();
                    else alert('Eroare: VerificƒÉ politicile RLS √Æn Supabase!');
                }
            }

            function startEdit(item) {
                setEditingItem(item);
                setPropForm({ title: item.title, price: item.price, location: item.location, type: item.type, bedrooms: item.bedrooms });
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24">
                    {/* Header & Install Button */}
                    <header className="p-6 bg-white shadow-sm flex justify-between items-center sticky top-0 z-50">
                        <h1 className="text-xl font-bold text-orange-600">Malta RE PRO</h1>
                        <button id="install-btn" className="hidden bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-sm font-bold border border-orange-200">
                            InstaleazƒÉ App
                        </button>
                    </header>

                    {/* Navigation Tabs */}
                    <nav className="flex bg-white border-b sticky top-[72px] z-40">
                        {['properties', 'clients', 'daily_notes'].map(tab => (
                            <button 
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`flex-1 py-4 text-sm capitalize ${activeTab === tab ? 'tab-active' : 'text-gray-500'}`}
                            >
                                {tab.replace('_', ' ')}
                            </button>
                        ))}
                    </nav>

                    <main className="p-4">
                        {/* Dynamic Form */}
                        {activeTab === 'properties' && (
                            <section className="glass p-5 rounded-3xl shadow-sm mb-6 border-t-4 border-orange-500">
                                <h2 className="font-bold mb-4">{editingItem ? 'üìù EditeazƒÉ' : 'üè† AdaugƒÉ Proprietate'}</h2>
                                <form onSubmit={handleSave} className="space-y-3">
                                    <input className="w-full p-3 rounded-xl border" placeholder="Titlu" value={propForm.title} onChange={e => setPropForm({...propForm, title: e.target.value})} required />
                                    <div className="flex gap-2">
                                        <input className="flex-1 p-3 rounded-xl border" type="number" placeholder="Pre»õ (‚Ç¨)" value={propForm.price} onChange={e => setPropForm({...propForm, price: e.target.value})} required />
                                        <input className="w-20 p-3 rounded-xl border" type="number" placeholder="Beds" value={propForm.bedrooms} onChange={e => setPropForm({...propForm, bedrooms: e.target.value})} />
                                    </div>
                                    <input className="w-full p-3 rounded-xl border" placeholder="Loca»õie (ex: Sliema)" value={propForm.location} onChange={e => setPropForm({...propForm, location: e.target.value})} required />
                                    <button type="submit" className="w-full bg-orange-500 text-white p-4 rounded-2xl font-bold shadow-lg shadow-orange-200">
                                        {editingItem ? 'SalveazƒÉ ModificƒÉrile' : 'AdaugƒÉ Proprietate'}
                                    </button>
                                </form>
                            </section>
                        )}

                        {/* List Items */}
                        <div className="space-y-4">
                            {loading ? (
                                <div className="text-center py-10 text-gray-400">Se √ÆncarcƒÉ datele...</div>
                            ) : items.map(item => (
                                <div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                                    <div>
                                        <h3 className="font-bold text-gray-800">{item.title || item.name || item.content}</h3>
                                        <p className="text-sm text-gray-500">{item.location} {item.price ? `‚Ä¢ ‚Ç¨${item.price}` : ''}</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => startEdit(item)} className="p-2 bg-blue-50 text-blue-600 rounded-lg"><i data-lucide="edit-3" className="w-4 h-4"></i></button>
                                        <button onClick={() => handleDelete(item.id)} className="p-2 bg-red-50 text-red-600 rounded-lg"><i data-lucide="trash-2" className="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>
                </div>
            );
        }

        // --- PWA LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('install-btn');
            if(btn) btn.classList.remove('hidden');
        });

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').catch(err => console.log('SW Error', err));
            });
        }
    </script>
</body>
</html>